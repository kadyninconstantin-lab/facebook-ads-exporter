<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Ads Library –≠–∫—Å–ø–æ—Ä—Ç–µ—Ä v6.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --color-primary: #1877f2;
            --color-error: #e74c3c;
            --color-success: #27ae60;
            --color-bg: #f0f2f5;
            --color-text: #050505;
            --color-border: #ccc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: var(--color-primary);
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #65676b;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .version-badge {
            background: var(--color-success);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-left: 10px;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--color-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--color-text);
        }

        label .optional {
            color: #65676b;
            font-weight: 400;
            font-size: 12px;
        }

        label .required {
            color: var(--color-error);
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(24, 119, 242, 0.1);
        }

        .help-text {
            font-size: 12px;
            color: #65676b;
            margin-top: 5px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #165dbf;
            box-shadow: 0 2px 8px rgba(24, 119, 242, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary {
            background: white;
            color: var(--color-primary);
            border: 2px solid var(--color-primary);
        }

        .btn-secondary:hover {
            background: #f0f2f5;
        }

        .btn-download {
            background: var(--color-success);
            color: white;
            padding: 10px 20px;
            font-size: 13px;
        }

        .btn-download:hover {
            background: #229954;
        }

        .btn-download:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-download-all {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .btn-download-all:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-info {
            background: #e7f3ff;
            color: #004085;
            border-left: 4px solid #0066cc;
        }

        .alert-error {
            background: #ffe7e7;
            color: #721c24;
            border-left: 4px solid var(--color-error);
        }

        .alert-success {
            background: #e7ffe7;
            color: #155724;
            border-left: 4px solid var(--color-success);
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .results-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid var(--color-primary);
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .stat-label {
            font-size: 12px;
            color: #65676b;
            margin-top: 5px;
        }

        .ads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .ad-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .ad-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .ad-media {
            width: 100%;
            height: 250px;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .ad-media img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ad-media-placeholder {
            color: #65676b;
            font-size: 48px;
        }

        .ad-media-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .ad-content {
            padding: 15px;
        }

        .ad-page-name {
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .ad-text {
            color: #333;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 12px;
            max-height: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ad-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
            color: #65676b;
            margin-bottom: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e5ea;
        }

        .ad-stat-item {
            display: flex;
            flex-direction: column;
        }

        .ad-stat-label {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .ad-actions {
            display: flex;
            gap: 8px;
        }

        .ad-actions button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .search-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            border-color: var(--color-primary);
            background: #e7f3ff;
        }

        .mode-btn h4 {
            color: var(--color-primary);
            margin-bottom: 5px;
        }

        .mode-btn p {
            font-size: 12px;
            color: #65676b;
        }

        .country-select {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 4px;
        }

        .country-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }

        .country-checkbox input {
            width: auto;
        }

        .lookup-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background: white;
            border: 1px solid var(--color-border);
        }

        .lookup-success {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--color-success);
        }

        .lookup-error {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--color-error);
        }

        .lookup-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--color-primary);
        }

        .lookup-icon {
            font-size: 24px;
        }

        .lookup-info {
            flex: 1;
        }

        .lookup-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--color-text);
        }

        .lookup-id {
            font-size: 14px;
            color: #65676b;
            margin-top: 3px;
        }

        .lookup-id strong {
            color: var(--color-primary);
            font-family: monospace;
            font-size: 15px;
        }

        .btn-small {
            padding: 8px 16px;
            background: var(--color-success);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .btn-small:hover {
            background: #229954;
        }

        .mini-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #65676b;
            font-size: 13px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--color-border);
        }

        .divider span {
            padding: 0 15px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #65676b;
        }

        .modal-close:hover {
            color: var(--color-error);
        }

        .modal-content h3 {
            color: var(--color-primary);
            margin-bottom: 20px;
        }

        .instruction-step {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--color-primary);
        }

        .instruction-step h4 {
            color: var(--color-text);
            margin-bottom: 10px;
            font-size: 15px;
        }

        .instruction-step ol {
            margin-left: 20px;
            font-size: 14px;
            line-height: 1.8;
        }

        .instruction-step code {
            background: #e7f3ff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: var(--color-primary);
        }

        .instruction-step kbd {
            background: #333;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }

        .export-section {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 2px solid var(--color-primary);
        }

        .export-section h3 {
            margin-bottom: 15px;
            color: var(--color-primary);
        }

        .export-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .download-progress {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .download-progress.active {
            display: block;
        }

        .progress-bar-container {
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .three-col {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .two-col, .three-col, .ads-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }

            h1 {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Facebook Ads Library –≠–∫—Å–ø–æ—Ä—Ç–µ—Ä <span class="version-badge">v6.0</span></h1>
        <p class="subtitle">–ü–æ–ª–Ω–∞—è –≤—ã–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ–º –º–µ–¥–∏–∞</p>

        <div id="alerts"></div>

        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è –í–∞–∂–Ω–æ:</strong> Ads Library API —Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä <code>ad_reached_countries</code>. 
            –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ Page ID –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID (–º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ —á–µ—Ä–µ–∑ lookup-id.com).
        </div>

        <div class="form-section">
            <h3 style="margin-bottom: 15px; color: var(--color-primary);">üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
            
            <div class="form-group">
                <label for="accessToken">Access Token <span class="required">*</span></label>
                <input type="password" id="accessToken" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Facebook Access Token">
                <div class="help-text">
                    User Token —Å permissions: ads_read, ads_management
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3 style="margin-bottom: 15px; color: var(--color-primary);">üîç –†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞</h3>
            
            <div class="search-mode-toggle">
                <button class="mode-btn active" onclick="setSearchMode('page')" id="mode-page">
                    <h4>üìÑ –ü–æ Page ID</h4>
                    <p>–ü–æ–∏—Å–∫ –≤—Å–µ—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã</p>
                </button>
                <button class="mode-btn" onclick="setSearchMode('keyword')" id="mode-keyword">
                    <h4>üî§ –ü–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º</h4>
                    <p>–ü–æ–∏—Å–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ —Ç–µ–∫—Å—Ç—É</p>
                </button>
            </div>

            <div id="pageSearchFields">
                <div class="form-group">
                    <label for="pageUrl">üîó URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã Facebook</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="pageUrl" placeholder="https://www.facebook.com/pagename/" style="flex: 1;">
                        <button class="btn-primary" onclick="lookupPageId()" id="lookupBtn" style="white-space: nowrap;">
                            üîç –ù–∞–π—Ç–∏ ID
                        </button>
                    </div>
                    <div class="help-text">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É Facebook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è ID</div>
                </div>

                <div id="lookupResult" class="lookup-result" style="display: none;">
                    <div class="lookup-success" id="lookupSuccess" style="display: none;">
                        <span class="lookup-icon">‚úÖ</span>
                        <div class="lookup-info">
                            <div class="lookup-name" id="foundPageName">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</div>
                            <div class="lookup-id">Page ID: <strong id="foundPageId">123456789</strong></div>
                        </div>
                        <button class="btn-small" onclick="useFoundId()">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="lookup-error" id="lookupError" style="display: none;">
                        <span class="lookup-icon">‚ùå</span>
                        <div class="lookup-info" id="lookupErrorText">–û—à–∏–±–∫–∞</div>
                    </div>
                    <div class="lookup-loading" id="lookupLoading" style="display: none;">
                        <div class="mini-spinner"></div>
                        <span>–ü–æ–∏—Å–∫ Page ID...</span>
                    </div>
                </div>

                <div class="divider">
                    <span>–∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID –≤—Ä—É—á–Ω—É—é</span>
                </div>

                <div class="form-group">
                    <label for="pageId">Page ID <span class="required">*</span></label>
                    <input type="text" id="pageId" placeholder="–ß–∏—Å–ª–æ–≤–æ–π ID —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä: 123456789">
                    <div class="help-text">
                        –ï—Å–ª–∏ –∞–≤—Ç–æ–ø–æ–∏—Å–∫ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –Ω–∞–π–¥–∏—Ç–µ ID –≤—Ä—É—á–Ω—É—é: 
                        <a href="#" onclick="showManualInstructions(); return false;">–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</a>
                    </div>
                </div>

                <div id="manualModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <span class="modal-close" onclick="closeManualModal()">&times;</span>
                        <h3>üìñ –ö–∞–∫ –Ω–∞–π—Ç–∏ Page ID –≤—Ä—É—á–Ω—É—é</h3>
                        
                        <div class="instruction-step">
                            <h4>–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ lookup-id.com</h4>
                            <ol>
                                <li>–û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://lookup-id.com" target="_blank">lookup-id.com</a></li>
                                <li>–í—Å—Ç–∞–≤—å—Ç–µ URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã Facebook</li>
                                <li>–ù–∞–∂–º–∏—Ç–µ "Lookup"</li>
                                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID</li>
                            </ol>
                        </div>

                        <div class="instruction-step">
                            <h4>–°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h4>
                            <ol>
                                <li>–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É Facebook –≤ –±—Ä–∞—É–∑–µ—Ä–µ</li>
                                <li>–ù–∞–∂–º–∏—Ç–µ <kbd>Ctrl+U</kbd> (–∏–ª–∏ –ü–ö–ú ‚Üí "–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã")</li>
                                <li>–ù–∞–∂–º–∏—Ç–µ <kbd>Ctrl+F</kbd> –¥–ª—è –ø–æ–∏—Å–∫–∞</li>
                                <li>–ù–∞–π–¥–∏—Ç–µ: <code>"pageID"</code> –∏–ª–∏ <code>"page_id"</code> –∏–ª–∏ <code>entity_id</code></li>
                                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä—è–¥–æ–º</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <div id="keywordSearchFields" style="display: none;">
                <div class="form-group">
                    <label for="searchTerms">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ <span class="required">*</span></label>
                    <input type="text" id="searchTerms" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞">
                    <div class="help-text">–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3 style="margin-bottom: 15px; color: var(--color-primary);">üåç –°—Ç—Ä–∞–Ω—ã –ø–æ–∫–∞–∑–∞ <span class="required">*</span></h3>
            <p style="font-size: 13px; color: #65676b; margin-bottom: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω—É (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä API)</p>
            
            <div class="country-select" id="countrySelect">
                <label class="country-checkbox"><input type="checkbox" value="US" checked> üá∫üá∏ US</label>
                <label class="country-checkbox"><input type="checkbox" value="GB"> üá¨üáß UK</label>
                <label class="country-checkbox"><input type="checkbox" value="DE"> üá©üá™ DE</label>
                <label class="country-checkbox"><input type="checkbox" value="FR"> üá´üá∑ FR</label>
                <label class="country-checkbox"><input type="checkbox" value="IT"> üáÆüáπ IT</label>
                <label class="country-checkbox"><input type="checkbox" value="ES"> üá™üá∏ ES</label>
                <label class="country-checkbox"><input type="checkbox" value="CA"> üá®üá¶ CA</label>
                <label class="country-checkbox"><input type="checkbox" value="AU"> üá¶üá∫ AU</label>
                <label class="country-checkbox"><input type="checkbox" value="BR"> üáßüá∑ BR</label>
                <label class="country-checkbox"><input type="checkbox" value="MX"> üá≤üáΩ MX</label>
                <label class="country-checkbox"><input type="checkbox" value="IN"> üáÆüá≥ IN</label>
                <label class="country-checkbox"><input type="checkbox" value="JP"> üáØüáµ JP</label>
                <label class="country-checkbox"><input type="checkbox" value="KR"> üá∞üá∑ KR</label>
                <label class="country-checkbox"><input type="checkbox" value="PL"> üáµüá± PL</label>
                <label class="country-checkbox"><input type="checkbox" value="NL"> üá≥üá± NL</label>
                <label class="country-checkbox"><input type="checkbox" value="UA"> üá∫üá¶ UA</label>
                <label class="country-checkbox"><input type="checkbox" value="RU"> üá∑üá∫ RU</label>
                <label class="country-checkbox"><input type="checkbox" value="ALL"> üåç ALL</label>
            </div>
        </div>

        <div class="form-section">
            <h3 style="margin-bottom: 15px; color: var(--color-primary);">‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</h3>
            
            <div class="three-col">
                <div class="form-group">
                    <label for="adType">–¢–∏–ø –æ–±—ä—è–≤–ª–µ–Ω–∏–π</label>
                    <select id="adType">
                        <option value="ALL">–í—Å–µ —Ç–∏–ø—ã</option>
                        <option value="POLITICAL_AND_ISSUE_ADS">–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ</option>
                        <option value="HOUSING">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</option>
                        <option value="EMPLOYMENT">–¢—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</option>
                        <option value="CREDIT">–ö—Ä–µ–¥–∏—Ç—ã</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="adStatus">–°—Ç–∞—Ç—É—Å –æ–±—ä—è–≤–ª–µ–Ω–∏–π</label>
                    <select id="adStatus">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="ACTIVE">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="INACTIVE">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="limit">–õ–∏–º–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</label>
                    <select id="limit">
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="250">250</option>
                        <option value="500">500</option>
                    </select>
                </div>
            </div>

            <div class="two-col">
                <div class="form-group">
                    <label for="mediaType">–¢–∏–ø –º–µ–¥–∏–∞ <span class="optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></label>
                    <select id="mediaType">
                        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                        <option value="IMAGE">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</option>
                        <option value="VIDEO">–í–∏–¥–µ–æ</option>
                        <option value="MEME">Meme</option>
                        <option value="NONE">–ë–µ–∑ –º–µ–¥–∏–∞</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="publisherPlatform">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ <span class="optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></label>
                    <select id="publisherPlatform">
                        <option value="">–í—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</option>
                        <option value="FACEBOOK">Facebook</option>
                        <option value="INSTAGRAM">Instagram</option>
                        <option value="AUDIENCE_NETWORK">Audience Network</option>
                        <option value="MESSENGER">Messenger</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-primary" onclick="fetchAds()" id="fetchBtn">üîç –ü–æ–ª—É—á–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è</button>
            <button class="btn-secondary" onclick="clearForm()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="btn-secondary" onclick="testConnection()">üîå –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
        </div>

        <div id="resultsSection" class="results-section">
            <div class="stats" id="stats"></div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π...</p>
            </div>

            <div class="export-section">
                <h3>üì¶ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                <div class="export-buttons">
                    <button class="btn-download-all" onclick="downloadAllMedia()" id="downloadAllBtn" disabled>
                        üì• –°–∫–∞—á–∞—Ç—å –≤—Å–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã (ZIP)
                    </button>
                    <button class="btn-download" onclick="downloadFullCSV()">
                        üìÑ –°–∫–∞—á–∞—Ç—å CSV
                    </button>
                    <button class="btn-download" onclick="downloadJSON()">
                        üìÑ –°–∫–∞—á–∞—Ç—å JSON
                    </button>
                </div>
                
                <div id="downloadProgress" class="download-progress">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span id="progressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</span>
                        <span id="progressCount">0 / 0</span>
                    </div>
                    <div class="progress-bar-container">
                        <div id="progressBar" class="progress-bar"></div>
                    </div>
                    <div id="progressDetails" class="progress-text"></div>
                </div>
            </div>

            <div id="adsGrid" class="ads-grid"></div>
        </div>
    </div>

    <script>
        let allAds = [];
        let searchMode = 'page';
        let foundPageData = null;

        function extractUsernameFromUrl(url) {
            url = url.trim();
            
            if (/^\d+$/.test(url)) {
                return { type: 'id', value: url };
            }
            
            const patterns = [
                /facebook\.com\/pages\/[^\/]+\/(\d+)/i,
                /facebook\.com\/profile\.php\?id=(\d+)/i,
                /facebook\.com\/people\/[^\/]+\/(\d+)/i,
                /facebook\.com\/([a-zA-Z0-9._-]+)\/?(?:\?|$|#)/i,
                /fb\.com\/([a-zA-Z0-9._-]+)\/?/i,
            ];
            
            for (let pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    const value = match[1];
                    if (/^\d+$/.test(value)) {
                        return { type: 'id', value: value };
                    }
                    return { type: 'username', value: value };
                }
            }
            
            return { type: 'username', value: url };
        }

        async function lookupPageId() {
            const pageUrl = document.getElementById('pageUrl').value.trim();
            const accessToken = document.getElementById('accessToken').value.trim();
            
            if (!pageUrl) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã Facebook', 'error');
                return;
            }
            
            const resultDiv = document.getElementById('lookupResult');
            const successDiv = document.getElementById('lookupSuccess');
            const errorDiv = document.getElementById('lookupError');
            const loadingDiv = document.getElementById('lookupLoading');
            
            resultDiv.style.display = 'block';
            successDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            loadingDiv.style.display = 'flex';
            
            document.getElementById('lookupBtn').disabled = true;
            
            try {
                const extracted = extractUsernameFromUrl(pageUrl);
                
                if (extracted.type === 'id') {
                    foundPageData = {
                        id: extracted.value,
                        name: 'ID –∏–∑ URL'
                    };
                    showLookupSuccess(foundPageData);
                    return;
                }
                
                if (accessToken) {
                    try {
                        const graphResult = await lookupViaGraphAPI(extracted.value, accessToken);
                        if (graphResult) {
                            foundPageData = graphResult;
                            showLookupSuccess(foundPageData);
                            return;
                        }
                    } catch (e) {
                        console.log('Graph API failed:', e.message);
                    }
                }
                
                if (!accessToken) {
                    showLookupError(`
                        <strong>–í–≤–µ–¥–∏—Ç–µ Access Token</strong> –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ Page ID.<br><br>
                        –ò–ª–∏ –Ω–∞–π–¥–∏—Ç–µ ID –≤—Ä—É—á–Ω—É—é:<br>
                        <a href="#" onclick="showManualInstructions(); return false;">üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</a>
                    `);
                    return;
                }
                
                showLookupError(`
                    –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç—å Page ID –¥–ª—è "${extracted.value}".<br><br>
                    <a href="#" onclick="showManualInstructions(); return false;">üìñ –ö–∞–∫ –Ω–∞–π—Ç–∏ ID –≤—Ä—É—á–Ω—É—é</a>
                `);
                
            } catch (error) {
                showLookupError(`–û—à–∏–±–∫–∞: ${error.message}`);
            } finally {
                loadingDiv.style.display = 'none';
                document.getElementById('lookupBtn').disabled = false;
            }
        }

        async function lookupViaGraphAPI(identifier, accessToken) {
            const url = `https://graph.facebook.com/v21.0/${identifier}?fields=id,name,fan_count,category&access_token=${accessToken}`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }
            
            if (data.id) {
                return {
                    id: data.id,
                    name: data.name || identifier,
                    fans: data.fan_count,
                    category: data.category
                };
            }
            
            return null;
        }

        function showLookupSuccess(data) {
            const successDiv = document.getElementById('lookupSuccess');
            const errorDiv = document.getElementById('lookupError');
            
            document.getElementById('foundPageName').textContent = data.name;
            document.getElementById('foundPageId').textContent = data.id;
            
            let extra = '';
            if (data.fans) extra += ` ‚Ä¢ ${data.fans.toLocaleString()} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤`;
            if (data.category) extra += ` ‚Ä¢ ${data.category}`;
            if (extra) {
                document.getElementById('foundPageId').innerHTML = 
                    `${data.id} <span style="color: #65676b; font-weight: normal; font-size: 12px;">${extra}</span>`;
            }
            
            successDiv.style.display = 'flex';
            errorDiv.style.display = 'none';
        }

        function showLookupError(message) {
            const successDiv = document.getElementById('lookupSuccess');
            const errorDiv = document.getElementById('lookupError');
            
            document.getElementById('lookupErrorText').innerHTML = message;
            
            successDiv.style.display = 'none';
            errorDiv.style.display = 'flex';
        }

        function useFoundId() {
            if (foundPageData && foundPageData.id) {
                document.getElementById('pageId').value = foundPageData.id;
                showAlert(`‚úÖ Page ID ${foundPageData.id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞`, 'success');
                
                document.getElementById('pageId').scrollIntoView({ behavior: 'smooth', block: 'center' });
                document.getElementById('pageId').focus();
            }
        }

        function showManualInstructions() {
            document.getElementById('manualModal').style.display = 'flex';
        }

        function closeManualModal() {
            document.getElementById('manualModal').style.display = 'none';
        }

        document.addEventListener('click', function(e) {
            const modal = document.getElementById('manualModal');
            if (e.target === modal) {
                closeManualModal();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeManualModal();
            }
        });

        function setSearchMode(mode) {
            searchMode = mode;
            
            document.getElementById('mode-page').classList.toggle('active', mode === 'page');
            document.getElementById('mode-keyword').classList.toggle('active', mode === 'keyword');
            
            document.getElementById('pageSearchFields').style.display = mode === 'page' ? 'block' : 'none';
            document.getElementById('keywordSearchFields').style.display = mode === 'keyword' ? 'block' : 'none';
        }

        function getSelectedCountries() {
            const checkboxes = document.querySelectorAll('#countrySelect input:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function buildApiUrl() {
            const accessToken = document.getElementById('accessToken').value;
            const pageId = document.getElementById('pageId').value;
            const searchTerms = document.getElementById('searchTerms').value;
            const countries = getSelectedCountries();
            const adType = document.getElementById('adType').value;
            const adStatus = document.getElementById('adStatus').value;
            const limit = document.getElementById('limit').value;
            const mediaType = document.getElementById('mediaType').value;
            const platform = document.getElementById('publisherPlatform').value;

            const url = new URL('https://graph.facebook.com/v21.0/ads_archive');
            
            url.searchParams.append('access_token', accessToken);
            url.searchParams.append('ad_reached_countries', JSON.stringify(countries));
            url.searchParams.append('ad_type', adType);
            url.searchParams.append('limit', limit);
            
            const fields = [
                'id', 'ad_archive_id', 'ad_creation_time', 'ad_creative_bodies',
                'ad_creative_link_captions', 'ad_creative_link_descriptions',
                'ad_creative_link_titles', 'ad_delivery_start_time', 'ad_delivery_stop_time',
                'ad_snapshot_url', 'bylines', 'currency', 'delivery_by_region',
                'demographic_distribution', 'estimated_audience_size', 'impressions',
                'languages', 'page_id', 'page_name', 'publisher_platforms',
                'spend', 'target_ages', 'target_gender', 'target_locations'
            ];
            url.searchParams.append('fields', fields.join(','));
            
            if (searchMode === 'page' && pageId) {
                url.searchParams.append('search_page_ids', pageId);
            }
            
            if (searchMode === 'keyword' && searchTerms) {
                url.searchParams.append('search_terms', searchTerms);
            }
            
            if (adStatus) {
                url.searchParams.append('ad_active_status', adStatus);
            }
            
            if (mediaType) {
                url.searchParams.append('media_type', mediaType);
            }
            
            if (platform) {
                url.searchParams.append('publisher_platforms', JSON.stringify([platform]));
            }

            return url.toString();
        }

        async function testConnection() {
            const accessToken = document.getElementById('accessToken').value;
            
            if (!accessToken) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ Access Token', 'error');
                return;
            }

            showAlert('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...', 'info');
            
            try {
                const response = await fetch(`https://graph.facebook.com/v21.0/me?access_token=${accessToken}`);
                const data = await response.json();
                
                if (data.error) {
                    showAlert(`‚ùå –û—à–∏–±–∫–∞ —Ç–æ–∫–µ–Ω–∞: ${data.error.message}`, 'error');
                } else {
                    showAlert(`‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.name || data.id}`, 'success');
                }
            } catch (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        async function fetchAds() {
            const accessToken = document.getElementById('accessToken').value;
            const pageId = document.getElementById('pageId').value;
            const searchTerms = document.getElementById('searchTerms').value;
            const countries = getSelectedCountries();

            if (!accessToken) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ Access Token', 'error');
                return;
            }

            if (countries.length === 0) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω—É', 'error');
                return;
            }

            if (searchMode === 'page' && !pageId) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ Page ID', 'error');
                return;
            }

            if (searchMode === 'keyword' && !searchTerms) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞', 'error');
                return;
            }

            showLoading(true, '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Ads Library API...');
            clearAlerts();
            document.getElementById('resultsSection').classList.add('active');

            try {
                const apiUrl = buildApiUrl();
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.error) {
                    let errorMsg = `‚ùå –û—à–∏–±–∫–∞ API: ${data.error.message}`;
                    
                    if (data.error.code === 190) {
                        errorMsg += '\n\nüí° –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∏–ª–∏ –∏—Å—Ç—ë–∫. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω.';
                    } else if (data.error.code === 10) {
                        errorMsg += '\n\nüí° –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ permissions —Ç–æ–∫–µ–Ω–∞.';
                    }
                    
                    showAlert(errorMsg, 'error');
                    showLoading(false);
                    return;
                }

                allAds = data.data || [];
                
                let nextUrl = data.paging?.next;
                let pageCount = 1;
                
                while (nextUrl && pageCount < 10) {
                    pageCount++;
                    showLoading(true, `–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageCount}...`);
                    
                    const nextResponse = await fetch(nextUrl);
                    const nextData = await nextResponse.json();
                    
                    if (nextData.data) {
                        allAds = allAds.concat(nextData.data);
                    }
                    
                    nextUrl = nextData.paging?.next;
                }

                displayResults(allAds);
                showAlert(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allAds.length} –æ–±—ä—è–≤–ª–µ–Ω–∏–π`, 'success');
                
                document.getElementById('downloadAllBtn').disabled = allAds.length === 0;

            } catch (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        function extractMediaUrl(ad) {
            // Facebook Ads Library –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –º–µ–¥–∏–∞
            // –ú–µ–¥–∏–∞ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ snapshot_url (iframe —Å —Ä–µ–∫–ª–∞–º–æ–π)
            // –î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å snapshot_url
            return ad.ad_snapshot_url || null;
        }

        function displayResults(ads) {
            const stats = {
                total: ads.length,
                pages: [...new Set(ads.map(a => a.page_name).filter(Boolean))].length,
                platforms: [...new Set(ads.flatMap(a => a.publisher_platforms || []))],
                totalSpend: ads.reduce((sum, a) => {
                    const spend = a.spend?.lower_bound || 0;
                    return sum + parseFloat(spend);
                }, 0)
            };

            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">–û–±—ä—è–≤–ª–µ–Ω–∏–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.pages}</div>
                    <div class="stat-label">–°—Ç—Ä–∞–Ω–∏—Ü</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.platforms.length}</div>
                    <div class="stat-label">–ü–ª–∞—Ç—Ñ–æ—Ä–º</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${stats.totalSpend.toLocaleString()}</div>
                    <div class="stat-label">–ú–∏–Ω. –∑–∞—Ç—Ä–∞—Ç—ã</div>
                </div>
            `;

            const adsHtml = ads.map((ad, index) => {
                const bodies = ad.ad_creative_bodies || [];
                const text = bodies[0] || '–¢–µ–∫—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                const impressions = ad.impressions || {};
                const spend = ad.spend || {};
                const platforms = ad.publisher_platforms || [];
                const snapshotUrl = ad.ad_snapshot_url || '';

                return `
                    <div class="ad-card">
                        <div class="ad-media">
                            <div class="ad-media-placeholder">üì∑</div>
                            <div class="ad-media-badge">Ad #${index + 1}</div>
                        </div>
                        <div class="ad-content">
                            <div class="ad-page-name">${ad.page_name || 'Unknown Page'}</div>
                            <div class="ad-text">${text.substring(0, 150)}${text.length > 150 ? '...' : ''}</div>
                            <div class="ad-stats">
                                <div class="ad-stat-item">
                                    <span class="ad-stat-label">–ü–æ–∫–∞–∑—ã:</span>
                                    <span>${impressions.lower_bound || '?'} - ${impressions.upper_bound || '?'}</span>
                                </div>
                                <div class="ad-stat-item">
                                    <span class="ad-stat-label">–ó–∞—Ç—Ä–∞—Ç—ã:</span>
                                    <span>${spend.lower_bound || '?'} - ${spend.upper_bound || '?'} ${ad.currency || ''}</span>
                                </div>
                                <div class="ad-stat-item">
                                    <span class="ad-stat-label">–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã:</span>
                                    <span>${platforms.slice(0, 2).join(', ') || 'N/A'}</span>
                                </div>
                                <div class="ad-stat-item">
                                    <span class="ad-stat-label">–°–æ–∑–¥–∞–Ω–æ:</span>
                                    <span>${ad.ad_creation_time ? new Date(ad.ad_creation_time).toLocaleDateString() : 'N/A'}</span>
                                </div>
                            </div>
                            <div class="ad-actions">
                                ${snapshotUrl ? `
                                    <button class="btn-download" onclick="downloadAdMedia(${index})">
                                        üì• –°–∫–∞—á–∞—Ç—å
                                    </button>
                                    <button class="btn-secondary" onclick="window.open('${snapshotUrl}', '_blank')" style="padding: 8px; font-size: 12px;">
                                        üîó –û—Ç–∫—Ä—ã—Ç—å
                                    </button>
                                ` : `
                                    <button class="btn-download" disabled>
                                        –ù–µ—Ç –º–µ–¥–∏–∞
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('adsGrid').innerHTML = adsHtml || 
                '<p style="padding: 20px; text-align: center; color: #999;">–û–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        }

        async function downloadAdMedia(index) {
            const ad = allAds[index];
            if (!ad || !ad.ad_snapshot_url) {
                showAlert('–ù–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ', 'warning');
                return;
            }

            const adId = ad.ad_archive_id || `ad_${index}`;
            const pageName = (ad.page_name || 'unknown').replace(/[^a-zA-Z0-9]/g, '_');
            const filename = `${pageName}_${adId}.html`;

            try {
                const response = await fetch(ad.ad_snapshot_url);
                const html = await response.text();
                
                const blob = new Blob([html], { type: 'text/html' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert(`‚úÖ –°–∫–∞—á–∞–Ω–æ: ${filename}`, 'success');
            } catch (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        async function downloadAllMedia() {
            if (allAds.length === 0) {
                showAlert('–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'warning');
                return;
            }

            const progressDiv = document.getElementById('downloadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressCount = document.getElementById('progressCount');
            const progressDetails = document.getElementById('progressDetails');

            progressDiv.classList.add('active');
            progressText.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞...';
            progressBar.style.width = '0%';
            document.getElementById('downloadAllBtn').disabled = true;

            try {
                const zip = new JSZip();
                const adsWithMedia = allAds.filter(ad => ad.ad_snapshot_url);
                
                progressCount.textContent = `0 / ${adsWithMedia.length}`;
                
                for (let i = 0; i < adsWithMedia.length; i++) {
                    const ad = adsWithMedia[i];
                    const adId = ad.ad_archive_id || `ad_${i}`;
                    const pageName = (ad.page_name || 'unknown').replace(/[^a-zA-Z0-9]/g, '_');
                    
                    progressText.textContent = `–°–∫–∞—á–∏–≤–∞–Ω–∏–µ ${i + 1} –∏–∑ ${adsWithMedia.length}...`;
                    progressCount.textContent = `${i + 1} / ${adsWithMedia.length}`;
                    progressBar.style.width = `${((i + 1) / adsWithMedia.length) * 100}%`;
                    
                    try {
                        const response = await fetch(ad.ad_snapshot_url);
                        const html = await response.text();
                        
                        zip.file(`${pageName}_${adId}.html`, html);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                        const metadata = {
                            ad_id: adId,
                            page_name: ad.page_name,
                            page_id: ad.page_id,
                            created: ad.ad_creation_time,
                            text: (ad.ad_creative_bodies || [])[0] || '',
                            snapshot_url: ad.ad_snapshot_url
                        };
                        zip.file(`${pageName}_${adId}_metadata.json`, JSON.stringify(metadata, null, 2));
                        
                    } catch (error) {
                        console.error(`Failed to download ad ${adId}:`, error);
                    }
                }

                progressText.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ZIP –∞—Ä—Ö–∏–≤–∞...';
                progressBar.style.width = '90%';

                const zipBlob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });

                progressText.textContent = '–ì–æ—Ç–æ–≤–æ!';
                progressBar.style.width = '100%';

                const filename = `fb_ads_media_${Date.now()}.zip`;
                saveAs(zipBlob, filename);

                progressDetails.textContent = `‚úÖ –°–∫–∞—á–∞–Ω–æ ${adsWithMedia.length} –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ –∞—Ä—Ö–∏–≤ ${filename}`;
                showAlert(`‚úÖ ZIP –∞—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: ${filename}`, 'success');

                setTimeout(() => {
                    progressDiv.classList.remove('active');
                }, 3000);

            } catch (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞: ${error.message}`, 'error');
                progressDiv.classList.remove('active');
            } finally {
                document.getElementById('downloadAllBtn').disabled = false;
            }
        }

        function downloadFullCSV() {
            if (allAds.length === 0) {
                showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'warning');
                return;
            }

            const headers = [
                'ad_archive_id', 'page_name', 'page_id', 'ad_text',
                'impressions_min', 'impressions_max', 'spend_min', 'spend_max',
                'currency', 'creation_time', 'platforms', 'snapshot_url'
            ];

            const rows = allAds.map((ad) => {
                const bodies = ad.ad_creative_bodies || [];
                const impressions = ad.impressions || {};
                const spend = ad.spend || {};
                const platforms = ad.publisher_platforms || [];

                return [
                    ad.ad_archive_id || '',
                    escapeCSV(ad.page_name || ''),
                    ad.page_id || '',
                    escapeCSV((bodies[0] || '').substring(0, 1000)),
                    impressions.lower_bound || '',
                    impressions.upper_bound || '',
                    spend.lower_bound || '',
                    spend.upper_bound || '',
                    ad.currency || '',
                    ad.ad_creation_time || '',
                    platforms.join('; '),
                    ad.ad_snapshot_url || ''
                ];
            });

            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');

            const filename = `fb_ads_export_${Date.now()}.csv`;
            downloadFile(csv, filename, 'text/csv;charset=utf-8');
            showAlert(`‚úÖ CSV —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω: ${filename}`, 'success');
        }

        function escapeCSV(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/"/g, '""').replace(/\n/g, ' ').replace(/\r/g, '');
        }

        function downloadJSON() {
            if (allAds.length === 0) {
                showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'warning');
                return;
            }

            const json = JSON.stringify(allAds, null, 2);
            downloadFile(json, `fb_ads_raw_${Date.now()}.json`, 'application/json');
            showAlert('‚úÖ JSON —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω', 'success');
        }

        function downloadFile(content, filename, type) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + content], { type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function showAlert(message, type) {
            const alertsDiv = document.getElementById('alerts');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message.replace(/\n/g, '<br>');
            alertsDiv.appendChild(alertDiv);

            if (type !== 'error') {
                setTimeout(() => alertDiv.remove(), 5000);
            }
        }

        function clearAlerts() {
            document.getElementById('alerts').innerHTML = '';
        }

        function showLoading(show, text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
            document.getElementById('loading').classList.toggle('active', show);
            document.getElementById('loadingText').textContent = text;
            document.getElementById('fetchBtn').disabled = show;
        }

        function clearForm() {
            document.getElementById('accessToken').value = '';
            document.getElementById('pageId').value = '';
            document.getElementById('searchTerms').value = '';
            document.querySelectorAll('#countrySelect input').forEach(cb => {
                cb.checked = cb.value === 'US';
            });
            document.getElementById('adType').value = 'ALL';
            document.getElementById('adStatus').value = '';
            document.getElementById('limit').value = '100';
            document.getElementById('mediaType').value = '';
            document.getElementById('publisherPlatform').value = '';
            document.getElementById('resultsSection').classList.remove('active');
            allAds = [];
            clearAlerts();
            setSearchMode('page');
        }

        document.addEventListener('DOMContentLoaded', () => {
            setSearchMode('page');
        });
    </script>
</body>
</html>

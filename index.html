<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Ads Library –≠–∫—Å–ø–æ—Ä—Ç–µ—Ä v5.0</title>
    <!-- JSZip –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è ZIP –∞—Ä—Ö–∏–≤–æ–≤ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --color-primary: #1877f2;
            --color-error: #e74c3c;
            --color-success: #27ae60;
            --color-bg: #f0f2f5;
            --color-text: #050505;
            --color-border: #ccc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: var(--color-primary);
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #65676b;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .version-badge {
            background: var(--color-success);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-left: 10px;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--color-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--color-text);
        }

        label .optional {
            color: #65676b;
            font-weight: 400;
            font-size: 12px;
        }

        label .required {
            color: var(--color-error);
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(24, 119, 242, 0.1);
        }

        .help-text {
            font-size: 12px;
            color: #65676b;
            margin-top: 5px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #165dbf;
            box-shadow: 0 2px 8px rgba(24, 119, 242, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary {
            background: white;
            color: var(--color-primary);
            border: 2px solid var(--color-primary);
        }

        .btn-secondary:hover {
            background: #f0f2f5;
        }

        .btn-download {
            background: var(--color-success);
            color: white;
        }

        .btn-download:hover {
            background: #229954;
        }

        .btn-download:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-info {
            background: #e7f3ff;
            color: #004085;
            border-left: 4px solid #0066cc;
        }

        .alert-error {
            background: #ffe7e7;
            color: #721c24;
            border-left: 4px solid var(--color-error);
        }

        .alert-success {
            background: #e7ffe7;
            color: #155724;
            border-left: 4px solid var(--color-success);
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .results-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid var(--color-primary);
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .stat-label {
            font-size: 12px;
            color: #65676b;
            margin-top: 5px;
        }

        .ads-list {
            background: white;
            border-radius: 4px;
            max-height: 600px;
            overflow-y: auto;
        }

        .ad-item {
            padding: 15px;
            border-bottom: 1px solid #e5e5ea;
            font-size: 13px;
        }

        .ad-item:last-child {
            border-bottom: none;
        }

        .ad-title {
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .ad-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            color: #65676b;
        }

        .meta-item {
            display: flex;
            justify-content: space-between;
        }

        .ad-link {
            margin-top: 10px;
        }

        .ad-link a {
            color: var(--color-primary);
            text-decoration: none;
            font-size: 12px;
        }

        .ad-link a:hover {
            text-decoration: underline;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .code-block {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            color: #333;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e5ea;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            color: #65676b;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .three-col {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .search-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            border-color: var(--color-primary);
            background: #e7f3ff;
        }

        .mode-btn h4 {
            color: var(--color-primary);
            margin-bottom: 5px;
        }

        .mode-btn p {
            font-size: 12px;
            color: #65676b;
        }

        .country-select {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 4px;
        }

        .country-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }

        .country-checkbox input {
            width: auto;
        }

        /* Lookup Tool Styles */
        .lookup-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background: white;
            border: 1px solid var(--color-border);
        }

        .lookup-success {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--color-success);
        }

        .lookup-error {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--color-error);
        }

        .lookup-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--color-primary);
        }

        .lookup-icon {
            font-size: 24px;
        }

        .lookup-info {
            flex: 1;
        }

        .lookup-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--color-text);
        }

        .lookup-id {
            font-size: 14px;
            color: #65676b;
            margin-top: 3px;
        }

        .lookup-id strong {
            color: var(--color-primary);
            font-family: monospace;
            font-size: 15px;
        }

        .btn-small {
            padding: 8px 16px;
            background: var(--color-success);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .btn-small:hover {
            background: #229954;
        }

        .mini-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #65676b;
            font-size: 13px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--color-border);
        }

        .divider span {
            padding: 0 15px;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #65676b;
        }

        .modal-close:hover {
            color: var(--color-error);
        }

        .modal-content h3 {
            color: var(--color-primary);
            margin-bottom: 20px;
        }

        .instruction-step {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--color-primary);
        }

        .instruction-step h4 {
            color: var(--color-text);
            margin-bottom: 10px;
            font-size: 15px;
        }

        .instruction-step ol {
            margin-left: 20px;
            font-size: 14px;
            line-height: 1.8;
        }

        .instruction-step code {
            background: #e7f3ff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: var(--color-primary);
        }

        .instruction-step kbd {
            background: #333;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }

        .alternative-methods {
            margin-top: 15px;
            padding: 12px;
            background: #fff3cd;
            border-radius: 6px;
            font-size: 13px;
        }

        .alternative-methods a {
            color: var(--color-primary);
        }

        /* Export Section Styles */
        .export-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .export-checkbox:hover {
            background: #e7f3ff;
        }

        .export-checkbox input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .export-checkbox input:checked + span {
            color: var(--color-primary);
            font-weight: 600;
        }

        .btn-download {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-download:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 768px) {
            .two-col, .three-col {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }

            h1 {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Facebook Ads Library –≠–∫—Å–ø–æ—Ä—Ç–µ—Ä <span class="version-badge">v5.0</span></h1>
        <p class="subtitle">–ü–æ–ª–Ω–∞—è –≤—ã–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞–º–∏ | –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≤–∏–¥–µ–æ –≤ ZIP</p>

        <div id="alerts"></div>

        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è –í–∞–∂–Ω–æ:</strong> Ads Library API —Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä <code>ad_reached_countries</code>. 
            –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ Page ID –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID (–º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ —á–µ—Ä–µ–∑ lookup-id.com).
        </div>

        <div class="form-section">
            <h3 style="margin-bottom: 15px; color: var(--color-primary);">üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
            
            <div class="form-group">
                <label for="accessToken">Access Token <span class="required">*</span></label>
                <input type="password" id="accessToken" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Facebook Access Token">
                <div class="help-text">
                    User Token —Å permissions: ads_read, ads_management
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3 style="margin-bottom: 15px; color: var(--color-primary);">üîç –†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞</h3>
            
            <div class="search-mode-toggle">
                <button class="mode-btn active" onclick="setSearchMode('page')" id="mode-page">
                    <h4>üìÑ –ü–æ Page ID</h4>
                    <p>–ü–æ–∏—Å–∫ –≤—Å–µ—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã</p>
                </button>
                <button class="mode-btn" onclick="setSearchMode('keyword')" id="mode-keyword">
                    <h4>üî§ –ü–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º</h4>
                    <p>–ü–æ–∏—Å–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ —Ç–µ–∫—Å—Ç—É</p>
                </button>
            </div>

            <div id="pageSearchFields">
                <div class="form-group">
                    <label for="pageUrl">üîó URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã Facebook</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="pageUrl" placeholder="https://www.facebook.com/sierramadregear/" style="flex: 1;">
                        <button class="btn-primary" onclick="lookupPageId()" id="lookupBtn" style="white-space: nowrap;">
                            üîç –ù–∞–π—Ç–∏ ID
                        </button>
                    </div>
                    <div class="help-text">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É Facebook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è ID</div>
                </div>

                <div id="lookupResult" class="lookup-result" style="display: none;">
                    <div class="lookup-success" id="lookupSuccess" style="display: none;">
                        <span class="lookup-icon">‚úÖ</span>
                        <div class="lookup-info">
                            <div class="lookup-name" id="foundPageName">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</div>
                            <div class="lookup-id">Page ID: <strong id="foundPageId">123456789</strong></div>
                        </div>
                        <button class="btn-small" onclick="useFoundId()">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="lookup-error" id="lookupError" style="display: none;">
                        <span class="lookup-icon">‚ùå</span>
                        <div class="lookup-info" id="lookupErrorText">–û—à–∏–±–∫–∞</div>
                    </div>
                    <div class="lookup-loading" id="lookupLoading" style="display: none;">
                        <div class="mini-spinner"></div>
                        <span>–ü–æ–∏—Å–∫ Page ID...</span>
                    </div>
                </div>

                <div class="divider">
                    <span>–∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID –≤—Ä—É—á–Ω—É—é</span>
                </div>

                <div class="form-group">
                    <label for="pageId">Page ID <span class="required">*</span></label>
                    <input type="text" id="pageId" placeholder="–ß–∏—Å–ª–æ–≤–æ–π ID —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä: 123456789">
                    <div class="help-text">
                        –ï—Å–ª–∏ –∞–≤—Ç–æ–ø–æ–∏—Å–∫ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –Ω–∞–π–¥–∏—Ç–µ ID –≤—Ä—É—á–Ω—É—é: 
                        <a href="#" onclick="showManualInstructions(); return false;">–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</a>
                    </div>
                </div>

                <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π -->
                <div id="manualModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <span class="modal-close" onclick="closeManualModal()">&times;</span>
                        <h3>üìñ –ö–∞–∫ –Ω–∞–π—Ç–∏ Page ID –≤—Ä—É—á–Ω—É—é</h3>
                        
                        <div class="instruction-step">
                            <h4>–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ lookup-id.com</h4>
                            <ol>
                                <li>–û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://lookup-id.com" target="_blank">lookup-id.com</a></li>
                                <li>–í—Å—Ç–∞–≤—å—Ç–µ URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã Facebook</li>
                                <li>–ù–∞–∂–º–∏—Ç–µ "Lookup"</li>
                                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID</li>
                            </ol>
                        </div>

                        <div class="instruction-step">
                            <h4>–°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h4>
                            <ol>
                                <li>–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É Facebook –≤ –±—Ä–∞—É–∑–µ—Ä–µ</li>
                                <li>–ù–∞–∂–º–∏—Ç–µ <kbd>Ctrl+U</kbd> (–∏–ª–∏ –ü–ö–ú ‚Üí "–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã")</li>
                                <li>–ù–∞–∂–º–∏—Ç–µ <kbd>Ctrl+F</kbd> –¥–ª—è –ø–æ–∏—Å–∫–∞</li>
                                <li>–ù–∞–π–¥–∏—Ç–µ: <code>"pageID"</code> –∏–ª–∏ <code>"page_id"</code> –∏–ª–∏ <code>entity_id</code></li>
                                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä—è–¥–æ–º</li>
                            </ol>
                        </div>

                        <div class="instruction-step">
                            <h4>–°–ø–æ—Å–æ–± 3: –ß–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª "–û —Å—Ç—Ä–∞–Ω–∏—Ü–µ"</h4>
                            <ol>
                                <li>–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É Facebook</li>
                                <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–û —Å—Ç—Ä–∞–Ω–∏—Ü–µ" (About)</li>
                                <li>–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –≤–Ω–∏–∑ –¥–æ "Page ID" –∏–ª–∏ "Transparency"</li>
                                <li>ID –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∫–∞–∑–∞–Ω —Ç–∞–º</li>
                            </ol>
                        </div>

                        <div class="instruction-step">
                            <h4>–°–ø–æ—Å–æ–± 4: –ß–µ—Ä–µ–∑ Facebook Ads Library –Ω–∞–ø—Ä—è–º—É—é</h4>
                            <ol>
                                <li>–û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://www.facebook.com/ads/library" target="_blank">Facebook Ads Library</a></li>
                                <li>–ù–∞–π–¥–∏—Ç–µ –Ω—É–∂–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</li>
                                <li>–í URL –±—É–¥–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä <code>view_all_page_id=XXXXX</code></li>
                                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ —á–∏—Å–ª–æ</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <div id="keywordSearchFields" style="display: none;">
                <div class="form-group">
                    <label for="searchTerms">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ <span class="required">*</span></label>
                    <input type="text" id="searchTerms" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞">
                    <div class="help-text">–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3 style="margin-bottom: 15px; color: var(--color-primary);">üåç –°—Ç—Ä–∞–Ω—ã –ø–æ–∫–∞–∑–∞ <span class="required">*</span></h3>
            <p style="font-size: 13px; color: #65676b; margin-bottom: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω—É (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä API)</p>
            
            <div class="country-select" id="countrySelect">
                <label class="country-checkbox"><input type="checkbox" value="US" checked> üá∫üá∏ US</label>
                <label class="country-checkbox"><input type="checkbox" value="GB"> üá¨üáß UK</label>
                <label class="country-checkbox"><input type="checkbox" value="DE"> üá©üá™ DE</label>
                <label class="country-checkbox"><input type="checkbox" value="FR"> üá´üá∑ FR</label>
                <label class="country-checkbox"><input type="checkbox" value="IT"> üáÆüáπ IT</label>
                <label class="country-checkbox"><input type="checkbox" value="ES"> üá™üá∏ ES</label>
                <label class="country-checkbox"><input type="checkbox" value="CA"> üá®üá¶ CA</label>
                <label class="country-checkbox"><input type="checkbox" value="AU"> üá¶üá∫ AU</label>
                <label class="country-checkbox"><input type="checkbox" value="BR"> üáßüá∑ BR</label>
                <label class="country-checkbox"><input type="checkbox" value="MX"> üá≤üáΩ MX</label>
                <label class="country-checkbox"><input type="checkbox" value="IN"> üáÆüá≥ IN</label>
                <label class="country-checkbox"><input type="checkbox" value="JP"> üáØüáµ JP</label>
                <label class="country-checkbox"><input type="checkbox" value="KR"> üá∞üá∑ KR</label>
                <label class="country-checkbox"><input type="checkbox" value="PL"> üáµüá± PL</label>
                <label class="country-checkbox"><input type="checkbox" value="NL"> üá≥üá± NL</label>
                <label class="country-checkbox"><input type="checkbox" value="UA"> üá∫üá¶ UA</label>
                <label class="country-checkbox"><input type="checkbox" value="RU"> üá∑üá∫ RU</label>
                <label class="country-checkbox"><input type="checkbox" value="ALL"> üåê ALL</label>
            </div>
        </div>

        <div class="form-section">
            <h3 style="margin-bottom: 15px; color: var(--color-primary);">‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</h3>
            
            <div class="three-col">
                <div class="form-group">
                    <label for="adType">–¢–∏–ø –æ–±—ä—è–≤–ª–µ–Ω–∏–π</label>
                    <select id="adType">
                        <option value="ALL">–í—Å–µ —Ç–∏–ø—ã</option>
                        <option value="POLITICAL_AND_ISSUE_ADS">–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ</option>
                        <option value="HOUSING">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</option>
                        <option value="EMPLOYMENT">–¢—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</option>
                        <option value="CREDIT">–ö—Ä–µ–¥–∏—Ç—ã</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="adStatus">–°—Ç–∞—Ç—É—Å –æ–±—ä—è–≤–ª–µ–Ω–∏–π</label>
                    <select id="adStatus">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="ACTIVE">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="INACTIVE">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="limit">–õ–∏–º–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</label>
                    <select id="limit">
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="250">250</option>
                        <option value="500">500</option>
                    </select>
                </div>
            </div>

            <div class="two-col">
                <div class="form-group">
                    <label for="mediaType">–¢–∏–ø –º–µ–¥–∏–∞ <span class="optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></label>
                    <select id="mediaType">
                        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                        <option value="IMAGE">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</option>
                        <option value="VIDEO">–í–∏–¥–µ–æ</option>
                        <option value="MEME">Meme</option>
                        <option value="NONE">–ë–µ–∑ –º–µ–¥–∏–∞</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="publisherPlatform">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ <span class="optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></label>
                    <select id="publisherPlatform">
                        <option value="">–í—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</option>
                        <option value="FACEBOOK">Facebook</option>
                        <option value="INSTAGRAM">Instagram</option>
                        <option value="AUDIENCE_NETWORK">Audience Network</option>
                        <option value="MESSENGER">Messenger</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-primary" onclick="fetchAds()" id="fetchBtn">üîç –ü–æ–ª—É—á–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è</button>
            <button class="btn-secondary" onclick="clearForm()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="btn-secondary" onclick="testConnection()">üîå –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('preview')">üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
            <button class="tab-btn" onclick="switchTab('request')">üì° –ó–∞–ø—Ä–æ—Å API</button>
            <button class="tab-btn" onclick="switchTab('python')">üêç Python</button>
        </div>

        <div id="preview" class="tab-content active">
            <div id="resultsSection" class="results-section">
                <div class="stats" id="stats"></div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π...</p>
                </div>

                <div id="adsContainer" class="ads-list"></div>

                <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
                <div class="export-section" style="margin-top: 25px; padding: 20px; background: white; border-radius: 8px; border: 2px solid var(--color-primary);">
                    <h3 style="margin-bottom: 15px; color: var(--color-primary);">üì¶ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                    
                    <div class="export-options" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <label class="export-checkbox">
                            <input type="checkbox" id="exportText" checked> 
                            <span>üìù –¢–µ–∫—Å—Ç—ã –æ–±—ä—è–≤–ª–µ–Ω–∏–π</span>
                        </label>
                        <label class="export-checkbox">
                            <input type="checkbox" id="exportMedia" checked> 
                            <span>üñºÔ∏è –ú–µ–¥–∏–∞ —Å—Å—ã–ª–∫–∏ + —Å–∫—Ä–∏–ø—Ç—ã</span>
                        </label>
                        <label class="export-checkbox">
                            <input type="checkbox" id="exportStats" checked> 
                            <span>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (impressions, spend)</span>
                        </label>
                        <label class="export-checkbox">
                            <input type="checkbox" id="exportTargeting" checked> 
                            <span>üéØ –¢–∞—Ä–≥–µ—Ç–∏–Ω–≥ (–¥–µ–º–æ–≥—Ä–∞—Ñ–∏—è, —Ä–µ–≥–∏–æ–Ω—ã)</span>
                        </label>
                    </div>

                    <!-- –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                            <div style="color: white;">
                                <h4 style="margin: 0 0 5px 0;">üöÄ –ü–æ–ª–Ω–∞—è –≤—ã–≥—Ä—É–∑–∫–∞</h4>
                                <p style="margin: 0; font-size: 13px; opacity: 0.9;">CSV + JSON + –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –º–µ–¥–∏–∞</p>
                            </div>
                            <button class="btn-download" onclick="downloadMediaFiles()" style="background: white; color: #667eea; font-size: 16px; padding: 15px 30px;">
                                üì• –°–∫–∞—á–∞—Ç—å ZIP –∞—Ä—Ö–∏–≤
                            </button>
                        </div>
                    </div>

                    <div class="export-buttons" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <button class="btn-download" onclick="downloadFullCSV()" style="background: #27ae60;">
                            üì• –¢–æ–ª—å–∫–æ CSV
                        </button>
                        <button class="btn-download" onclick="downloadJSON()" style="background: #3498db;">
                            üì• –¢–æ–ª—å–∫–æ JSON
                        </button>
                        <button class="btn-download" onclick="downloadExcel()" style="background: #e67e22;">
                            üìä Excel (XLS)
                        </button>
                    </div>

                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –º–µ–¥–∏–∞ -->
                    <div id="mediaDownloadProgress" style="display: none; margin-top: 20px;">
                        <div class="progress-header" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span id="mediaProgressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</span>
                            <span id="mediaProgressCount">0 / 0</span>
                        </div>
                        <div class="progress-bar" style="height: 24px; background: #e0e0e0; border-radius: 12px; overflow: hidden;">
                            <div id="mediaProgressBar" style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div id="mediaProgressDetails" style="margin-top: 15px; font-size: 13px; color: #666; background: #f8f9fa; padding: 15px; border-radius: 8px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="request" class="tab-content">
            <div style="background: white; padding: 20px; border-radius: 8px;">
                <h3 style="margin-bottom: 15px; color: var(--color-primary);">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å</h3>
                <p style="font-size: 13px; color: #65676b; margin-bottom: 10px;">URL –∑–∞–ø—Ä–æ—Å–∞ –∫ API (–∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –≤—ã—à–µ):</p>
                <div class="code-block" id="requestUrl" style="word-break: break-all;">
                    –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–ª—É—á–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è" —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∑–∞–ø—Ä–æ—Å
                </div>
                
                <h4 style="margin-top: 20px; margin-bottom: 10px;">cURL –∫–æ–º–∞–Ω–¥–∞:</h4>
                <div class="code-block" id="curlCommand" style="word-break: break-all;">
                    curl –±—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
                </div>
            </div>
        </div>

        <div id="python" class="tab-content">
            <div style="background: white; padding: 20px; border-radius: 8px;">
                <h3 style="margin-bottom: 15px; color: var(--color-primary);">Python –°–∫—Ä–∏–ø—Ç v4.0</h3>
                <div class="code-block" style="max-height: 600px; overflow-y: auto; white-space: pre;">
import requests
import json
import csv
from datetime import datetime

class FacebookAdsLibraryAPI:
    """
    Facebook Ads Library API Client v4.0
    –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    """
    
    def __init__(self, access_token):
        self.access_token = access_token
        self.api_version = 'v21.0'
        self.base_url = f'https://graph.facebook.com/{self.api_version}'
        self.ads = []
    
    def get_ads_by_page(self, page_id, countries=['US'], ad_type='ALL', 
                        limit=100, ad_status=None):
        """
        –ü–æ–ª—É—á–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ Page ID
        
        Args:
            page_id: –ß–∏—Å–ª–æ–≤–æ–π ID —Å—Ç—Ä–∞–Ω–∏—Ü—ã Facebook
            countries: –°–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤ —Å—Ç—Ä–∞–Ω (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
            ad_type: –¢–∏–ø –æ–±—ä—è–≤–ª–µ–Ω–∏–π
            limit: –õ–∏–º–∏—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
            ad_status: –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É (ACTIVE/INACTIVE)
        """
        return self._fetch_ads(
            search_page_ids=page_id,
            countries=countries,
            ad_type=ad_type,
            limit=limit,
            ad_status=ad_status
        )
    
    def get_ads_by_keyword(self, search_terms, countries=['US'], 
                           ad_type='ALL', limit=100, ad_status=None):
        """
        –ü–æ–ª—É—á–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        
        Args:
            search_terms: –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
            countries: –°–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤ —Å—Ç—Ä–∞–Ω (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
            ad_type: –¢–∏–ø –æ–±—ä—è–≤–ª–µ–Ω–∏–π
            limit: –õ–∏–º–∏—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
            ad_status: –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
        """
        return self._fetch_ads(
            search_terms=search_terms,
            countries=countries,
            ad_type=ad_type,
            limit=limit,
            ad_status=ad_status
        )
    
    def _fetch_ads(self, search_page_ids=None, search_terms=None,
                   countries=['US'], ad_type='ALL', limit=100, ad_status=None):
        """–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API"""
        
        url = f'{self.base_url}/ads_archive'
        
        # –ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ)
        params = {
            'access_token': self.access_token,
            'ad_reached_countries': json.dumps(countries),  # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!
            'ad_type': ad_type,
            'limit': limit,
            'fields': ','.join([
                'id',
                'ad_archive_id', 
                'ad_creation_time',
                'ad_creative_bodies',
                'ad_creative_link_captions',
                'ad_creative_link_descriptions',
                'ad_creative_link_titles',
                'ad_delivery_start_time',
                'ad_delivery_stop_time',
                'ad_snapshot_url',
                'bylines',
                'currency',
                'delivery_by_region',
                'demographic_distribution',
                'estimated_audience_size',
                'impressions',
                'languages',
                'page_id',
                'page_name',
                'publisher_platforms',
                'spend',
                'target_ages',
                'target_gender',
                'target_locations'
            ])
        }
        
        # –£—Å–ª–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        if search_page_ids:
            params['search_page_ids'] = search_page_ids
        
        if search_terms:
            params['search_terms'] = search_terms
        
        if ad_status:
            params['ad_active_status'] = ad_status
        
        all_ads = []
        page_count = 0
        
        try:
            while True:
                page_count += 1
                print(f'üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã {page_count}...')
                
                response = requests.get(url, params=params)
                data = response.json()
                
                if 'error' in data:
                    print(f'‚ùå –û—à–∏–±–∫–∞ API: {data["error"]["message"]}')
                    print(f'   –ö–æ–¥: {data["error"].get("code")}')
                    print(f'   –¢–∏–ø: {data["error"].get("type")}')
                    break
                
                if 'data' in data:
                    all_ads.extend(data['data'])
                    print(f'   ‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {len(all_ads)} –æ–±—ä—è–≤–ª–µ–Ω–∏–π')
                
                # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
                if 'paging' in data and 'next' in data['paging']:
                    url = data['paging']['next']
                    params = {}  # URL —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                else:
                    break
            
            self.ads = all_ads
            print(f'\n‚úÖ –í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {len(all_ads)} –æ–±—ä—è–≤–ª–µ–Ω–∏–π')
            return all_ads
            
        except Exception as e:
            print(f'‚ùå –û—à–∏–±–∫–∞: {e}')
            return []
    
    def save_csv(self, filename=None):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ CSV"""
        if not self.ads:
            print('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')
            return
        
        if not filename:
            filename = f'fb_ads_{datetime.now().strftime("%Y%m%d_%H%M%S")}.csv'
        
        with open(filename, 'w', newline='', encoding='utf-8') as f:
            writer = csv.writer(f)
            
            # –ó–∞–≥–æ–ª–æ–≤–∫–∏
            writer.writerow([
                'ad_archive_id', 'page_name', 'page_id', 'ad_text',
                'creation_time', 'start_time', 'stop_time',
                'impressions_min', 'impressions_max',
                'spend_min', 'spend_max', 'currency',
                'platforms', 'snapshot_url'
            ])
            
            for ad in self.ads:
                bodies = ad.get('ad_creative_bodies', [])
                text = bodies[0] if bodies else ''
                
                imp = ad.get('impressions', {})
                spend = ad.get('spend', {})
                platforms = ad.get('publisher_platforms', [])
                
                writer.writerow([
                    ad.get('ad_archive_id', ''),
                    ad.get('page_name', ''),
                    ad.get('page_id', ''),
                    text[:500],
                    ad.get('ad_creation_time', ''),
                    ad.get('ad_delivery_start_time', ''),
                    ad.get('ad_delivery_stop_time', ''),
                    imp.get('lower_bound', '') if isinstance(imp, dict) else imp,
                    imp.get('upper_bound', '') if isinstance(imp, dict) else '',
                    spend.get('lower_bound', '') if isinstance(spend, dict) else spend,
                    spend.get('upper_bound', '') if isinstance(spend, dict) else '',
                    ad.get('currency', ''),
                    ', '.join(platforms) if platforms else '',
                    ad.get('ad_snapshot_url', '')
                ])
        
        print(f'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ {filename}')
    
    def save_json(self, filename=None):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ JSON"""
        if not self.ads:
            print('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')
            return
        
        if not filename:
            filename = f'fb_ads_{datetime.now().strftime("%Y%m%d_%H%M%S")}.json'
        
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(self.ads, f, indent=2, ensure_ascii=False)
        
        print(f'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ {filename}')


# ===== –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï =====
if __name__ == '__main__':
    
    # –í–∞—à Access Token
    ACCESS_TOKEN = 'YOUR_ACCESS_TOKEN_HERE'
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç
    api = FacebookAdsLibraryAPI(ACCESS_TOKEN)
    
    # –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–∏—Å–∫ –ø–æ Page ID
    ads = api.get_ads_by_page(
        page_id='123456789',      # –ß–∏—Å–ª–æ–≤–æ–π ID —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        countries=['US', 'GB'],    # –°—Ç—Ä–∞–Ω—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
        ad_type='ALL',
        limit=100
    )
    
    # –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º  
    # ads = api.get_ads_by_keyword(
    #     search_terms='fitness supplements',
    #     countries=['US'],
    #     ad_type='ALL',
    #     limit=100
    # )
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    if ads:
        api.save_csv()
        api.save_json()
                </div>
            </div>
        </div>
    </div>

    <script>
        let allAds = [];
        let searchMode = 'page';
        let lastRequestUrl = '';
        let foundPageData = null;

        // ===== PAGE ID LOOKUP FUNCTIONS =====
        
        function extractUsernameFromUrl(url) {
            // –û—á–∏—â–∞–µ–º URL
            url = url.trim();
            
            // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ —á–∏—Å–ª–æ–≤–æ–π ID - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
            if (/^\d+$/.test(url)) {
                return { type: 'id', value: url };
            }
            
            // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è username
            const patterns = [
                /facebook\.com\/pages\/[^\/]+\/(\d+)/i,  // facebook.com/pages/Name/123456
                /facebook\.com\/profile\.php\?id=(\d+)/i,  // facebook.com/profile.php?id=123456
                /facebook\.com\/people\/[^\/]+\/(\d+)/i,  // facebook.com/people/Name/123456
                /facebook\.com\/([a-zA-Z0-9._-]+)\/?(?:\?|$|#)/i,  // facebook.com/username
                /fb\.com\/([a-zA-Z0-9._-]+)\/?/i,  // fb.com/username
            ];
            
            for (let pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    const value = match[1];
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á–∏—Å–ª–æ–≤–æ–π –ª–∏ —ç—Ç–æ ID
                    if (/^\d+$/.test(value)) {
                        return { type: 'id', value: value };
                    }
                    return { type: 'username', value: value };
                }
            }
            
            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ username
            return { type: 'username', value: url };
        }

        async function lookupPageId() {
            const pageUrl = document.getElementById('pageUrl').value.trim();
            const accessToken = document.getElementById('accessToken').value.trim();
            
            if (!pageUrl) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã Facebook', 'error');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            const resultDiv = document.getElementById('lookupResult');
            const successDiv = document.getElementById('lookupSuccess');
            const errorDiv = document.getElementById('lookupError');
            const loadingDiv = document.getElementById('lookupLoading');
            
            resultDiv.style.display = 'block';
            successDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            loadingDiv.style.display = 'flex';
            
            document.getElementById('lookupBtn').disabled = true;
            
            try {
                const extracted = extractUsernameFromUrl(pageUrl);
                
                // –ï—Å–ª–∏ –∏–∑–≤–ª–µ–∫–ª–∏ —á–∏—Å–ª–æ–≤–æ–π ID –Ω–∞–ø—Ä—è–º—É—é –∏–∑ URL
                if (extracted.type === 'id') {
                    foundPageData = {
                        id: extracted.value,
                        name: 'ID –∏–∑ URL'
                    };
                    showLookupSuccess(foundPageData);
                    return;
                }
                
                // –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ Graph API (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω)
                if (accessToken) {
                    try {
                        const graphResult = await lookupViaGraphAPI(extracted.value, accessToken);
                        if (graphResult) {
                            foundPageData = graphResult;
                            showLookupSuccess(foundPageData);
                            return;
                        }
                    } catch (e) {
                        console.log('Graph API failed:', e.message);
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–º—É –º–µ—Ç–æ–¥—É
                    }
                }
                
                // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ - —á–µ—Ä–µ–∑ Ads Library
                if (accessToken) {
                    try {
                        const altResult = await lookupViaAlternative(extracted.value);
                        if (altResult) {
                            foundPageData = altResult;
                            showLookupSuccess(foundPageData);
                            return;
                        }
                    } catch (e) {
                        console.log('Alternative method failed:', e.message);
                    }
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ - –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º
                if (!accessToken) {
                    showLookupError(`
                        <strong>–í–≤–µ–¥–∏—Ç–µ Access Token</strong> –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ Page ID.<br><br>
                        –ò–ª–∏ –Ω–∞–π–¥–∏—Ç–µ ID –≤—Ä—É—á–Ω—É—é:<br>
                        <a href="#" onclick="showManualInstructions(); return false;">üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</a>
                    `);
                    return;
                }
                
                // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                showLookupError(`
                    –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç—å Page ID –¥–ª—è "${extracted.value}".<br><br>
                    <strong>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</strong><br>
                    ‚Ä¢ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–∏–≤–∞—Ç–Ω–∞—è –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç<br>
                    ‚Ä¢ –¢—Ä–µ–±—É—é—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ permissions<br>
                    ‚Ä¢ CORS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞<br><br>
                    <a href="#" onclick="showManualInstructions(); return false;">üìñ –ö–∞–∫ –Ω–∞–π—Ç–∏ ID –≤—Ä—É—á–Ω—É—é</a>
                `);
                
            } catch (error) {
                showLookupError(`–û—à–∏–±–∫–∞: ${error.message}`);
            } finally {
                loadingDiv.style.display = 'none';
                document.getElementById('lookupBtn').disabled = false;
            }
        }

        async function lookupViaGraphAPI(identifier, accessToken) {
            const url = `https://graph.facebook.com/v21.0/${identifier}?fields=id,name,fan_count,category&access_token=${accessToken}`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }
            
            if (data.id) {
                return {
                    id: data.id,
                    name: data.name || identifier,
                    fans: data.fan_count,
                    category: data.category
                };
            }
            
            return null;
        }

        async function lookupViaAlternative(identifier) {
            // –ú–µ—Ç–æ–¥: –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Ads Library API –ø–æ –∏–º–µ–Ω–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            // –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö permissions!
            
            const accessToken = document.getElementById('accessToken').value.trim();
            if (!accessToken) return null;
            
            try {
                // –ò—â–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ –∏–º–µ–Ω–∏ —á–µ—Ä–µ–∑ Ads Library
                const url = new URL('https://graph.facebook.com/v21.0/ads_archive');
                url.searchParams.append('access_token', accessToken);
                url.searchParams.append('ad_reached_countries', '["US"]');
                url.searchParams.append('search_terms', identifier);
                url.searchParams.append('ad_type', 'ALL');
                url.searchParams.append('fields', 'page_id,page_name');
                url.searchParams.append('limit', '10');
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.data && data.data.length > 0) {
                    // –ò—â–µ–º —Ç–æ—á–Ω–æ–µ –∏–ª–∏ –±–ª–∏–∑–∫–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–º–µ–Ω–∏
                    const normalizedSearch = identifier.toLowerCase().replace(/[^a-z0-9]/g, '');
                    
                    for (const ad of data.data) {
                        if (ad.page_name) {
                            const normalizedName = ad.page_name.toLowerCase().replace(/[^a-z0-9]/g, '');
                            if (normalizedName.includes(normalizedSearch) || normalizedSearch.includes(normalizedName)) {
                                return {
                                    id: ad.page_id,
                                    name: ad.page_name,
                                    source: 'Ads Library'
                                };
                            }
                        }
                    }
                    
                    // –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
                    const first = data.data[0];
                    if (first.page_id) {
                        return {
                            id: first.page_id,
                            name: first.page_name + ' (–≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ —Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞)',
                            source: 'Ads Library'
                        };
                    }
                }
            } catch (e) {
                console.log('Ads Library lookup failed:', e);
            }
            
            return null;
        }

        function showLookupSuccess(data) {
            const successDiv = document.getElementById('lookupSuccess');
            const errorDiv = document.getElementById('lookupError');
            
            document.getElementById('foundPageName').textContent = data.name;
            document.getElementById('foundPageId').textContent = data.id;
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            let extra = '';
            if (data.fans) extra += ` ‚Ä¢ ${data.fans.toLocaleString()} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤`;
            if (data.category) extra += ` ‚Ä¢ ${data.category}`;
            if (extra) {
                document.getElementById('foundPageId').innerHTML = 
                    `${data.id} <span style="color: #65676b; font-weight: normal; font-size: 12px;">${extra}</span>`;
            }
            
            successDiv.style.display = 'flex';
            errorDiv.style.display = 'none';
        }

        function showLookupError(message) {
            const successDiv = document.getElementById('lookupSuccess');
            const errorDiv = document.getElementById('lookupError');
            
            document.getElementById('lookupErrorText').innerHTML = message;
            
            successDiv.style.display = 'none';
            errorDiv.style.display = 'flex';
        }

        function useFoundId() {
            if (foundPageData && foundPageData.id) {
                document.getElementById('pageId').value = foundPageData.id;
                showAlert(`‚úÖ Page ID ${foundPageData.id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞`, 'success');
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ–ª—é
                document.getElementById('pageId').scrollIntoView({ behavior: 'smooth', block: 'center' });
                document.getElementById('pageId').focus();
            }
        }

        function showManualInstructions() {
            document.getElementById('manualModal').style.display = 'flex';
        }

        function closeManualModal() {
            document.getElementById('manualModal').style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('manualModal');
            if (e.target === modal) {
                closeManualModal();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeManualModal();
            }
        });

        function setSearchMode(mode) {
            searchMode = mode;
            
            document.getElementById('mode-page').classList.toggle('active', mode === 'page');
            document.getElementById('mode-keyword').classList.toggle('active', mode === 'keyword');
            
            document.getElementById('pageSearchFields').style.display = mode === 'page' ? 'block' : 'none';
            document.getElementById('keywordSearchFields').style.display = mode === 'keyword' ? 'block' : 'none';
        }

        function getSelectedCountries() {
            const checkboxes = document.querySelectorAll('#countrySelect input:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function buildApiUrl() {
            const accessToken = document.getElementById('accessToken').value;
            const pageId = document.getElementById('pageId').value;
            const searchTerms = document.getElementById('searchTerms').value;
            const countries = getSelectedCountries();
            const adType = document.getElementById('adType').value;
            const adStatus = document.getElementById('adStatus').value;
            const limit = document.getElementById('limit').value;
            const mediaType = document.getElementById('mediaType').value;
            const platform = document.getElementById('publisherPlatform').value;

            const url = new URL('https://graph.facebook.com/v21.0/ads_archive');
            
            // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            url.searchParams.append('access_token', accessToken || 'YOUR_TOKEN');
            url.searchParams.append('ad_reached_countries', JSON.stringify(countries));
            url.searchParams.append('ad_type', adType);
            url.searchParams.append('limit', limit);
            
            // –ü–æ–ª—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è (–≤–∫–ª—é—á–∞—è –º–µ–¥–∏–∞ URLs)
            const fields = [
                'id', 'ad_archive_id', 'ad_creation_time', 'ad_creative_bodies',
                'ad_creative_link_captions', 'ad_creative_link_descriptions',
                'ad_creative_link_titles', 'ad_delivery_start_time', 'ad_delivery_stop_time',
                'ad_snapshot_url', 'bylines', 'currency', 'delivery_by_region',
                'demographic_distribution', 'estimated_audience_size', 'impressions',
                'languages', 'page_id', 'page_name', 'publisher_platforms',
                'spend', 'target_ages', 'target_gender', 'target_locations'
            ];
            url.searchParams.append('fields', fields.join(','));
            
            // –£—Å–ª–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            if (searchMode === 'page' && pageId) {
                url.searchParams.append('search_page_ids', pageId);
            }
            
            if (searchMode === 'keyword' && searchTerms) {
                url.searchParams.append('search_terms', searchTerms);
            }
            
            if (adStatus) {
                url.searchParams.append('ad_active_status', adStatus);
            }
            
            if (mediaType) {
                url.searchParams.append('media_type', mediaType);
            }
            
            if (platform) {
                url.searchParams.append('publisher_platforms', JSON.stringify([platform]));
            }

            return url.toString();
        }

        function updateRequestDisplay() {
            const url = buildApiUrl();
            document.getElementById('requestUrl').textContent = url;
            document.getElementById('curlCommand').textContent = `curl -G "${url.split('?')[0]}" \\\n  --data-urlencode "access_token=YOUR_TOKEN" \\\n  ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)`;
        }

        async function testConnection() {
            const accessToken = document.getElementById('accessToken').value;
            
            if (!accessToken) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ Access Token', 'error');
                return;
            }

            showAlert('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...', 'info');
            
            try {
                const response = await fetch(`https://graph.facebook.com/v21.0/me?access_token=${accessToken}`);
                const data = await response.json();
                
                if (data.error) {
                    showAlert(`‚ùå –û—à–∏–±–∫–∞ —Ç–æ–∫–µ–Ω–∞: ${data.error.message}`, 'error');
                } else {
                    showAlert(`‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.name || data.id}`, 'success');
                }
            } catch (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        async function fetchAds() {
            const accessToken = document.getElementById('accessToken').value;
            const pageId = document.getElementById('pageId').value;
            const searchTerms = document.getElementById('searchTerms').value;
            const countries = getSelectedCountries();

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!accessToken) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ Access Token', 'error');
                return;
            }

            if (countries.length === 0) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω—É', 'error');
                return;
            }

            if (searchMode === 'page' && !pageId) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ Page ID', 'error');
                return;
            }

            if (searchMode === 'keyword' && !searchTerms) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞', 'error');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º URL –∑–∞–ø—Ä–æ—Å–∞
            lastRequestUrl = buildApiUrl();
            updateRequestDisplay();
            
            showLoading(true, '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Ads Library API...');
            clearAlerts();
            document.getElementById('resultsSection').classList.add('active');

            try {
                const response = await fetch(lastRequestUrl);
                const data = await response.json();

                if (data.error) {
                    let errorMsg = `‚ùå –û—à–∏–±–∫–∞ API: ${data.error.message}`;
                    
                    // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —Ç–∏–ø–∏—á–Ω—ã–º –æ—à–∏–±–∫–∞–º
                    if (data.error.code === 190) {
                        errorMsg += '\n\nüí° –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∏–ª–∏ –∏—Å—Ç—ë–∫. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω.';
                    } else if (data.error.code === 10) {
                        errorMsg += '\n\nüí° –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ permissions —Ç–æ–∫–µ–Ω–∞.';
                    } else if (data.error.message.includes('ad_reached_countries')) {
                        errorMsg += '\n\nüí° –ü–∞—Ä–∞–º–µ—Ç—Ä ad_reached_countries –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—ã.';
                    }
                    
                    showAlert(errorMsg, 'error');
                    showLoading(false);
                    return;
                }

                allAds = data.data || [];
                
                // –ü–∞–≥–∏–Ω–∞—Ü–∏—è - –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                let nextUrl = data.paging?.next;
                let pageCount = 1;
                
                while (nextUrl && pageCount < 10) { // –õ–∏–º–∏—Ç 10 —Å—Ç—Ä–∞–Ω–∏—Ü
                    pageCount++;
                    showLoading(true, `–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageCount}...`);
                    
                    const nextResponse = await fetch(nextUrl);
                    const nextData = await nextResponse.json();
                    
                    if (nextData.data) {
                        allAds = allAds.concat(nextData.data);
                    }
                    
                    nextUrl = nextData.paging?.next;
                }

                displayResults(allAds);
                showAlert(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allAds.length} –æ–±—ä—è–≤–ª–µ–Ω–∏–π`, 'success');

            } catch (error) {
                showAlert(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayResults(ads) {
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const stats = {
                total: ads.length,
                pages: [...new Set(ads.map(a => a.page_name).filter(Boolean))].length,
                platforms: [...new Set(ads.flatMap(a => a.publisher_platforms || []))],
                totalSpend: ads.reduce((sum, a) => {
                    const spend = a.spend?.lower_bound || 0;
                    return sum + parseFloat(spend);
                }, 0)
            };

            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">–û–±—ä—è–≤–ª–µ–Ω–∏–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.pages}</div>
                    <div class="stat-label">–°—Ç—Ä–∞–Ω–∏—Ü</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.platforms.length}</div>
                    <div class="stat-label">–ü–ª–∞—Ç—Ñ–æ—Ä–º</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${stats.totalSpend.toLocaleString()}</div>
                    <div class="stat-label">–ú–∏–Ω. –∑–∞—Ç—Ä–∞—Ç—ã</div>
                </div>
            `;

            // –°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
            const adsHtml = ads.slice(0, 100).map(ad => {
                const bodies = ad.ad_creative_bodies || [];
                const text = bodies[0] || '–¢–µ–∫—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                const impressions = ad.impressions || {};
                const spend = ad.spend || {};
                const platforms = ad.publisher_platforms || [];

                return `
                    <div class="ad-item">
                        <div class="ad-title">${text.substring(0, 150)}${text.length > 150 ? '...' : ''}</div>
                        <div class="ad-meta">
                            <div class="meta-item">
                                <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞:</span>
                                <span>${ad.page_name || 'N/A'}</span>
                            </div>
                            <div class="meta-item">
                                <span>Page ID:</span>
                                <span>${ad.page_id || 'N/A'}</span>
                            </div>
                            <div class="meta-item">
                                <span>Impressions:</span>
                                <span>${impressions.lower_bound || '?'} - ${impressions.upper_bound || '?'}</span>
                            </div>
                            <div class="meta-item">
                                <span>Spend:</span>
                                <span>${spend.lower_bound || '?'} - ${spend.upper_bound || '?'} ${ad.currency || ''}</span>
                            </div>
                            <div class="meta-item">
                                <span>–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã:</span>
                                <span>${platforms.join(', ') || 'N/A'}</span>
                            </div>
                            <div class="meta-item">
                                <span>–°–æ–∑–¥–∞–Ω–æ:</span>
                                <span>${ad.ad_creation_time || 'N/A'}</span>
                            </div>
                        </div>
                        ${ad.ad_snapshot_url ? `
                        <div class="ad-link">
                            <a href="${ad.ad_snapshot_url}" target="_blank">üîó –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</a>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            document.getElementById('adsContainer').innerHTML = adsHtml || 
                '<p style="padding: 20px; text-align: center; color: #999;">–û–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
            
            if (ads.length > 100) {
                document.getElementById('adsContainer').innerHTML += 
                    `<p style="padding: 10px; text-align: center; color: #666; background: #f0f0f0;">
                        –ü–æ–∫–∞–∑–∞–Ω–æ 100 –∏–∑ ${ads.length}. –°–∫–∞—á–∞–π—Ç–µ CSV/JSON –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞.
                    </p>`;
            }
        }

        // ===== –§–£–ù–ö–¶–ò–ò –≠–ö–°–ü–û–†–¢–ê =====

        function getPagePrefix() {
            // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤
            const firstAd = allAds[0];
            if (firstAd && firstAd.page_name) {
                return firstAd.page_name.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30);
            }
            return 'fb_ads';
        }

        function sanitizeFilename(name) {
            return name.replace(/[^a-zA-Z0-9._-]/g, '_').substring(0, 100);
        }

        function extractMediaFromAd(ad, index) {
            const media = [];
            const pagePrefix = getPagePrefix();
            const adId = ad.ad_archive_id || index;
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º URL –∏–∑ snapshot_url (–æ—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ/–≤–∏–¥–µ–æ)
            if (ad.ad_snapshot_url) {
                media.push({
                    type: 'snapshot',
                    url: ad.ad_snapshot_url,
                    filename: `${pagePrefix}_${adId}_snapshot.html`,
                    adId: adId
                });
            }

            // –ò–∑–≤–ª–µ–∫–∞–µ–º –º–µ–¥–∏–∞ –∏–∑ –æ–±—ä–µ–∫—Ç–∞ ad (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏)
            // Facebook Ads Library –æ–±—ã—á–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç snapshot_url, –Ω–æ –º–æ–∂–µ–º –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∏–∑–≤–ª–µ—á—å –±–æ–ª—å—à–µ
            
            return media;
        }

        function downloadFullCSV() {
            if (allAds.length === 0) {
                showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'warning');
                return;
            }

            const pagePrefix = getPagePrefix();
            const includeText = document.getElementById('exportText').checked;
            const includeMedia = document.getElementById('exportMedia').checked;
            const includeStats = document.getElementById('exportStats').checked;
            const includeTargeting = document.getElementById('exportTargeting').checked;

            // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            const headers = [
                'ad_archive_id',
                'page_name', 
                'page_id',
                'media_filename',  // –î–ª—è –º–µ—Ç—á–∏–Ω–≥–∞ —Å –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞–º–∏
                'snapshot_url'
            ];

            if (includeText) {
                headers.push('ad_text', 'link_caption', 'link_description', 'link_title');
            }

            if (includeStats) {
                headers.push(
                    'impressions_min', 'impressions_max',
                    'spend_min', 'spend_max', 'currency',
                    'estimated_audience_min', 'estimated_audience_max'
                );
            }

            headers.push('creation_time', 'start_time', 'stop_time', 'platforms', 'languages');

            if (includeTargeting) {
                headers.push(
                    'target_ages', 'target_gender', 'target_locations',
                    'demographic_male_13-17', 'demographic_male_18-24', 'demographic_male_25-34',
                    'demographic_male_35-44', 'demographic_male_45-54', 'demographic_male_55-64', 'demographic_male_65+',
                    'demographic_female_13-17', 'demographic_female_18-24', 'demographic_female_25-34',
                    'demographic_female_35-44', 'demographic_female_45-54', 'demographic_female_55-64', 'demographic_female_65+',
                    'regions_data'
                );
            }

            const rows = allAds.map((ad, index) => {
                const adId = ad.ad_archive_id || index;
                const bodies = ad.ad_creative_bodies || [];
                const captions = ad.ad_creative_link_captions || [];
                const descriptions = ad.ad_creative_link_descriptions || [];
                const titles = ad.ad_creative_link_titles || [];
                const impressions = ad.impressions || {};
                const spend = ad.spend || {};
                const audience = ad.estimated_audience_size || {};
                const platforms = ad.publisher_platforms || [];
                const languages = ad.languages || [];
                const demographics = ad.demographic_distribution || [];
                const regions = ad.delivery_by_region || [];
                const targetAges = ad.target_ages || '';
                const targetGender = ad.target_gender || '';
                const targetLocations = ad.target_locations || [];

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞ –¥–ª—è –º–µ—Ç—á–∏–Ω–≥–∞
                const mediaFilename = `${pagePrefix}_${adId}_media`;

                const row = [
                    adId,
                    escapeCSV(ad.page_name || ''),
                    ad.page_id || '',
                    mediaFilename,
                    ad.ad_snapshot_url || ''
                ];

                if (includeText) {
                    row.push(
                        escapeCSV((bodies[0] || '').substring(0, 1000)),
                        escapeCSV(captions[0] || ''),
                        escapeCSV(descriptions[0] || ''),
                        escapeCSV(titles[0] || '')
                    );
                }

                if (includeStats) {
                    row.push(
                        impressions.lower_bound || '',
                        impressions.upper_bound || '',
                        spend.lower_bound || '',
                        spend.upper_bound || '',
                        ad.currency || '',
                        audience.lower_bound || '',
                        audience.upper_bound || ''
                    );
                }

                row.push(
                    ad.ad_creation_time || '',
                    ad.ad_delivery_start_time || '',
                    ad.ad_delivery_stop_time || '',
                    platforms.join('; '),
                    languages.join('; ')
                );

                if (includeTargeting) {
                    // –ü–∞—Ä—Å–∏–º –¥–µ–º–æ–≥—Ä–∞—Ñ–∏—é
                    const demoData = parseDemographics(demographics);
                    
                    row.push(
                        targetAges,
                        targetGender,
                        JSON.stringify(targetLocations),
                        demoData['male_13-17'] || '',
                        demoData['male_18-24'] || '',
                        demoData['male_25-34'] || '',
                        demoData['male_35-44'] || '',
                        demoData['male_45-54'] || '',
                        demoData['male_55-64'] || '',
                        demoData['male_65+'] || '',
                        demoData['female_13-17'] || '',
                        demoData['female_18-24'] || '',
                        demoData['female_25-34'] || '',
                        demoData['female_35-44'] || '',
                        demoData['female_45-54'] || '',
                        demoData['female_55-64'] || '',
                        demoData['female_65+'] || '',
                        JSON.stringify(regions)
                    );
                }

                return row;
            });

            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');

            const filename = `${pagePrefix}_full_export_${Date.now()}.csv`;
            downloadFile(csv, filename, 'text/csv;charset=utf-8');
            showAlert(`‚úÖ –ü–æ–ª–Ω—ã–π CSV —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω: ${filename}`, 'success');
        }

        function escapeCSV(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/"/g, '""').replace(/\n/g, ' ').replace(/\r/g, '');
        }

        function parseDemographics(demographics) {
            const result = {};
            if (!Array.isArray(demographics)) return result;

            demographics.forEach(item => {
                const gender = item.gender || 'unknown';
                const age = item.age || 'unknown';
                const percentage = item.percentage || 0;
                const key = `${gender}_${age}`;
                result[key] = (percentage * 100).toFixed(2) + '%';
            });

            return result;
        }

        async function downloadMediaFiles() {
            if (allAds.length === 0) {
                showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'warning');
                return;
            }

            const pagePrefix = getPagePrefix();
            const progressDiv = document.getElementById('mediaDownloadProgress');
            const progressBar = document.getElementById('mediaProgressBar');
            const progressText = document.getElementById('mediaProgressText');
            const progressCount = document.getElementById('mediaProgressCount');
            const progressDetails = document.getElementById('mediaProgressDetails');

            progressDiv.style.display = 'block';
            progressText.textContent = '–°–±–æ—Ä —Å—Å—ã–ª–æ–∫ –Ω–∞ –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã...';
            progressBar.style.width = '0%';

            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ–¥–∏–∞ URL –∏–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
            const mediaItems = [];
            
            allAds.forEach((ad, index) => {
                const adId = ad.ad_archive_id || index;
                
                // Snapshot URL (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –ø—Ä–µ–≤—å—é)
                if (ad.ad_snapshot_url) {
                    mediaItems.push({
                        url: ad.ad_snapshot_url,
                        filename: `${pagePrefix}_${adId}_snapshot_link.txt`,
                        adId: adId,
                        type: 'snapshot_link',
                        downloadable: false
                    });
                }
            });

            if (mediaItems.length === 0) {
                showAlert('–ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
                progressDiv.style.display = 'none';
                return;
            }

            progressText.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ ZIP –∞—Ä—Ö–∏–≤–∞ —Å –¥–∞–Ω–Ω—ã–º–∏...';
            progressBar.style.width = '20%';

            try {
                const zip = new JSZip();
                const mediaFolder = zip.folder('media');
                const dataFolder = zip.folder('data');

                // 1. –î–æ–±–∞–≤–ª—è–µ–º CSV —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                const csvContent = generateFullCSVContent();
                dataFolder.file(`${pagePrefix}_ads_data.csv`, csvContent);

                // 2. –î–æ–±–∞–≤–ª—è–µ–º JSON —Å —Å—ã—Ä—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                dataFolder.file(`${pagePrefix}_raw_data.json`, JSON.stringify(allAds, null, 2));

                // 3. –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –∏–Ω–¥–µ–∫—Å–æ–º –º–µ–¥–∏–∞
                const mediaIndex = generateMediaIndex(pagePrefix);
                dataFolder.file(`${pagePrefix}_media_index.csv`, mediaIndex.csv);
                dataFolder.file(`${pagePrefix}_media_urls.txt`, mediaIndex.urls);

                // 4. –°–æ–∑–¥–∞–µ–º HTML —Ñ–∞–π–ª –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ snapshot —Å—Å—ã–ª–æ–∫
                const snapshotHtml = generateSnapshotViewerHtml(pagePrefix);
                mediaFolder.file(`snapshot_viewer.html`, snapshotHtml);

                // 5. –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const downloadScript = generateDownloadScript(pagePrefix);
                mediaFolder.file(`download_media.py`, downloadScript.python);
                mediaFolder.file(`download_media.sh`, downloadScript.bash);

                progressText.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ZIP –∞—Ä—Ö–∏–≤–∞...';
                progressBar.style.width = '70%';

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ZIP
                const zipBlob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                }, (metadata) => {
                    const percent = 70 + (metadata.percent * 0.3);
                    progressBar.style.width = `${percent}%`;
                });

                // –°–∫–∞—á–∏–≤–∞–µ–º ZIP
                const filename = `${pagePrefix}_ads_export_${Date.now()}.zip`;
                saveAs(zipBlob, filename);

                progressText.textContent = '‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!';
                progressBar.style.width = '100%';
                progressCount.textContent = `${allAds.length} –æ–±—ä—è–≤–ª–µ–Ω–∏–π`;
                
                progressDetails.innerHTML = `
                    <strong>‚úÖ ZIP –∞—Ä—Ö–∏–≤ —Å–∫–∞—á–∞–Ω: ${filename}</strong><br><br>
                    <strong>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞:</strong><br>
                    üìÅ <code>data/</code> - CSV –∏ JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π<br>
                    üìÅ <code>media/</code> - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –º–µ–¥–∏–∞<br><br>
                    <strong>–î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π/–≤–∏–¥–µ–æ:</strong><br>
                    1. –û—Ç–∫—Ä–æ–π—Ç–µ <code>media/snapshot_viewer.html</code> –≤ –±—Ä–∞—É–∑–µ—Ä–µ<br>
                    2. –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ <code>media/download_media.py</code> (—Ç—Ä–µ–±—É–µ—Ç—Å—è Python + Selenium)<br>
                    3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>media/download_media.sh</code> —Å wget
                `;

                showAlert(`‚úÖ ZIP –∞—Ä—Ö–∏–≤ —Å–∫–∞—á–∞–Ω: ${filename}`, 'success');

            } catch (error) {
                console.error('Error creating ZIP:', error);
                showAlert(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞: ${error.message}`, 'error');
                progressDiv.style.display = 'none';
            }
        }

        function generateFullCSVContent() {
            const pagePrefix = getPagePrefix();
            const headers = [
                'ad_archive_id', 'page_name', 'page_id', 'media_filename',
                'ad_text', 'link_caption', 'link_description', 'link_title',
                'impressions_min', 'impressions_max', 'spend_min', 'spend_max', 'currency',
                'creation_time', 'start_time', 'stop_time', 'platforms', 'languages',
                'target_ages', 'target_gender', 'snapshot_url'
            ];

            const rows = allAds.map((ad, index) => {
                const adId = ad.ad_archive_id || index;
                const bodies = ad.ad_creative_bodies || [];
                const captions = ad.ad_creative_link_captions || [];
                const descriptions = ad.ad_creative_link_descriptions || [];
                const titles = ad.ad_creative_link_titles || [];
                const impressions = ad.impressions || {};
                const spend = ad.spend || {};
                const platforms = ad.publisher_platforms || [];
                const languages = ad.languages || [];
                const mediaFilename = `${pagePrefix}_${adId}`;

                return [
                    adId,
                    escapeCSV(ad.page_name || ''),
                    ad.page_id || '',
                    mediaFilename,
                    escapeCSV((bodies[0] || '').substring(0, 1000)),
                    escapeCSV(captions[0] || ''),
                    escapeCSV(descriptions[0] || ''),
                    escapeCSV(titles[0] || ''),
                    impressions.lower_bound || '',
                    impressions.upper_bound || '',
                    spend.lower_bound || '',
                    spend.upper_bound || '',
                    ad.currency || '',
                    ad.ad_creation_time || '',
                    ad.ad_delivery_start_time || '',
                    ad.ad_delivery_stop_time || '',
                    platforms.join('; '),
                    languages.join('; '),
                    ad.target_ages || '',
                    ad.target_gender || '',
                    ad.ad_snapshot_url || ''
                ];
            });

            return '\uFEFF' + [headers, ...rows].map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
        }

        function generateMediaIndex(pagePrefix) {
            const csvRows = [['ad_archive_id', 'media_filename', 'snapshot_url', 'page_name']];
            const urlList = [];

            allAds.forEach((ad, index) => {
                const adId = ad.ad_archive_id || index;
                const mediaFilename = `${pagePrefix}_${adId}`;
                
                csvRows.push([
                    adId,
                    mediaFilename,
                    ad.ad_snapshot_url || '',
                    ad.page_name || ''
                ]);

                if (ad.ad_snapshot_url) {
                    urlList.push(`# Ad ID: ${adId}`);
                    urlList.push(ad.ad_snapshot_url);
                    urlList.push('');
                }
            });

            return {
                csv: '\uFEFF' + csvRows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n'),
                urls: urlList.join('\n')
            };
        }

        function generateSnapshotViewerHtml(pagePrefix) {
            const adsHtml = allAds.map((ad, index) => {
                const adId = ad.ad_archive_id || index;
                const bodies = ad.ad_creative_bodies || [];
                const text = (bodies[0] || '–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞').substring(0, 200);
                
                return `
                    <div class="ad-card">
                        <div class="ad-header">
                            <strong>${ad.page_name || 'Unknown'}</strong>
                            <span class="ad-id">ID: ${adId}</span>
                        </div>
                        <div class="ad-text">${text}${text.length >= 200 ? '...' : ''}</div>
                        <div class="ad-actions">
                            <a href="${ad.ad_snapshot_url || '#'}" target="_blank" class="btn">üîó –û—Ç–∫—Ä—ã—Ç—å Snapshot</a>
                            <button onclick="copyUrl('${ad.ad_snapshot_url || ''}')" class="btn btn-secondary">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL</button>
                        </div>
                    </div>
                `;
            }).join('\n');

            return `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${pagePrefix} - Snapshot Viewer</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #1877f2; }
        .stats { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .ad-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .ad-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .ad-id { color: #666; font-size: 12px; }
        .ad-text { color: #333; margin-bottom: 15px; font-size: 14px; line-height: 1.5; }
        .ad-actions { display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 13px; cursor: pointer; border: none; }
        .btn { background: #1877f2; color: white; }
        .btn-secondary { background: #e4e6eb; color: #050505; }
        .btn:hover { opacity: 0.9; }
        .instructions { background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä ${pagePrefix} - –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h1>
        <div class="stats">
            <strong>–í—Å–µ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π:</strong> ${allAds.length}
        </div>
        <div class="instructions">
            <strong>üí° –ö–∞–∫ —Å–∫–∞—á–∞—Ç—å –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã:</strong><br>
            1. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–∫—Ä—ã—Ç—å Snapshot" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è<br>
            2. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Facebook –ø—Ä–∞–≤—ã–π –∫–ª–∏–∫ ‚Üí "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫..."<br>
            3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Python —Å–∫—Ä–∏–ø—Ç download_media.py –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
        </div>
        <div id="ads">
            ${adsHtml}
        </div>
    </div>
    <script>
        function copyUrl(url) {
            navigator.clipboard.writeText(url);
            alert('URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
        }
    </script>
</body>
</html>`;
        }

        function generateDownloadScript(pagePrefix) {
            // Python —Å–∫—Ä–∏–ø—Ç —Å Selenium –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –º–µ–¥–∏–∞
            const pythonScript = `#!/usr/bin/env python3
"""
${pagePrefix} - Facebook Ads Media Downloader
–°–∫–∞—á–∏–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≤–∏–¥–µ–æ –∏–∑ snapshot —Å—Ç—Ä–∞–Ω–∏—Ü

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
pip install selenium webdriver-manager requests

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
python download_media.py
"""

import os
import time
import requests
import csv
import re
from urllib.parse import urlparse
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from webdriver_manager.chrome import ChromeDriverManager

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
OUTPUT_DIR = 'downloaded_media'
CSV_FILE = '../data/${pagePrefix}_media_index.csv'
DELAY_BETWEEN_ADS = 2  # —Å–µ–∫—É–Ω–¥—ã

def setup_driver():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Chrome WebDriver"""
    options = Options()
    options.add_argument('--headless')  # –ë–µ–∑ GUI
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    options.add_argument('--window-size=1920,1080')
    
    service = Service(ChromeDriverManager().install())
    return webdriver.Chrome(service=service, options=options)

def download_file(url, filepath):
    """–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –ø–æ URL"""
    try:
        response = requests.get(url, stream=True, timeout=30)
        response.raise_for_status()
        
        with open(filepath, 'wb') as f:
            for chunk in response.iter_content(chunk_size=8192):
                f.write(chunk)
        return True
    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: {e}")
        return False

def extract_media_from_snapshot(driver, snapshot_url, ad_id, output_dir):
    """–ò–∑–≤–ª–µ—á—å –∏ —Å–∫–∞—á–∞—Ç—å –º–µ–¥–∏–∞ –∏–∑ snapshot —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
    try:
        driver.get(snapshot_url)
        time.sleep(3)  # –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏
        
        downloaded = []
        
        # –ò—â–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        images = driver.find_elements(By.TAG_NAME, 'img')
        for i, img in enumerate(images):
            src = img.get_attribute('src')
            if src and 'scontent' in src:  # Facebook CDN
                ext = '.jpg'
                if '.png' in src:
                    ext = '.png'
                filename = f"{ad_id}_img_{i}{ext}"
                filepath = os.path.join(output_dir, filename)
                
                if download_file(src, filepath):
                    downloaded.append(filename)
                    print(f"  ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {filename}")
        
        # –ò—â–µ–º –≤–∏–¥–µ–æ
        videos = driver.find_elements(By.TAG_NAME, 'video')
        for i, video in enumerate(videos):
            src = video.get_attribute('src')
            if src:
                filename = f"{ad_id}_video_{i}.mp4"
                filepath = os.path.join(output_dir, filename)
                
                if download_file(src, filepath):
                    downloaded.append(filename)
                    print(f"  ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {filename}")
        
        return downloaded
        
    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞: {e}")
        return []

def main():
    # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –º–µ–¥–∏–∞
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    
    # –ß–∏—Ç–∞–µ–º CSV —Å –∏–Ω–¥–µ–∫—Å–æ–º
    ads_to_download = []
    with open(CSV_FILE, 'r', encoding='utf-8-sig') as f:
        reader = csv.DictReader(f)
        for row in reader:
            if row.get('snapshot_url'):
                ads_to_download.append(row)
    
    print(f"üìä –ù–∞–π–¥–µ–Ω–æ {len(ads_to_download)} –æ–±—ä—è–≤–ª–µ–Ω–∏–π –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è")
    print(f"üìÅ –ú–µ–¥–∏–∞ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: {OUTPUT_DIR}/")
    print("-" * 50)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±—Ä–∞—É–∑–µ—Ä
    driver = setup_driver()
    
    try:
        for i, ad in enumerate(ads_to_download, 1):
            ad_id = ad.get('ad_archive_id', f'ad_{i}')
            snapshot_url = ad.get('snapshot_url', '')
            
            print(f"\\n[{i}/{len(ads_to_download)}] –û–±—Ä–∞–±–æ—Ç–∫–∞: {ad_id}")
            
            files = extract_media_from_snapshot(driver, snapshot_url, ad_id, OUTPUT_DIR)
            
            if not files:
                print(f"  ‚ö†Ô∏è –ú–µ–¥–∏–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            
            time.sleep(DELAY_BETWEEN_ADS)
            
    finally:
        driver.quit()
    
    print("\\n" + "=" * 50)
    print("‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
    print(f"üìÅ –§–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ: {OUTPUT_DIR}/")

if __name__ == '__main__':
    main()
`;

            // Bash —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ wget (snapshot —Å—Å—ã–ª–∫–∏)
            const bashScript = `#!/bin/bash
# ${pagePrefix} - Download snapshot pages
# –°–∫–∞—á–∏–≤–∞–µ—Ç HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã snapshot –¥–ª—è –æ—Ñ–ª–∞–π–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

OUTPUT_DIR="snapshots"
mkdir -p "$OUTPUT_DIR"

echo "üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ snapshot —Å—Ç—Ä–∞–Ω–∏—Ü..."
echo ""

# –ß–∏—Ç–∞–µ–º URL –∏–∑ —Ñ–∞–π–ª–∞
while IFS= read -r line; do
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
    [[ "$line" =~ ^#.*$ ]] && continue
    [[ -z "$line" ]] && continue
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è)
    if [[ "$line" =~ ^https:// ]]; then
        filename=$(echo "$line" | grep -oP 'id=\\K[0-9]+' || echo "snapshot_$(date +%s)")
        echo "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ: $filename"
        wget -q -O "$OUTPUT_DIR/$filename.html" "$line" 2>/dev/null || echo "  ‚ö†Ô∏è –û—à–∏–±–∫–∞"
        sleep 1
    fi
done < "../data/${pagePrefix}_media_urls.txt"

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –§–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ: $OUTPUT_DIR/"
`;

            return {
                python: pythonScript,
                bash: bashScript
            };
        }

        function downloadJSON() {
            if (allAds.length === 0) {
                showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'warning');
                return;
            }

            const pagePrefix = getPagePrefix();
            const json = JSON.stringify(allAds, null, 2);
            downloadFile(json, `${pagePrefix}_raw_${Date.now()}.json`, 'application/json');
            showAlert('‚úÖ JSON —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω', 'success');
        }

        function downloadExcel() {
            if (allAds.length === 0) {
                showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'warning');
                return;
            }

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º XML –¥–ª—è Excel (–ø—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–º–∞—Ç)
            const pagePrefix = getPagePrefix();
            
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xml += '<?mso-application progid="Excel.Sheet"?>\n';
            xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"\n';
            xml += '  xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n';
            xml += '  <Worksheet ss:Name="Ads">\n';
            xml += '    <Table>\n';

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            const headers = [
                'ID', 'Page Name', 'Page ID', 'Media Filename', 'Text',
                'Impressions Min', 'Impressions Max', 'Spend Min', 'Spend Max',
                'Currency', 'Created', 'Started', 'Ended', 'Platforms', 'Snapshot URL'
            ];

            xml += '      <Row>\n';
            headers.forEach(h => {
                xml += `        <Cell><Data ss:Type="String">${escapeXML(h)}</Data></Cell>\n`;
            });
            xml += '      </Row>\n';

            // –î–∞–Ω–Ω—ã–µ
            allAds.forEach((ad, index) => {
                const adId = ad.ad_archive_id || index;
                const bodies = ad.ad_creative_bodies || [];
                const impressions = ad.impressions || {};
                const spend = ad.spend || {};
                const platforms = ad.publisher_platforms || [];
                const mediaFilename = `${pagePrefix}_${adId}_media`;

                xml += '      <Row>\n';
                const rowData = [
                    adId,
                    ad.page_name || '',
                    ad.page_id || '',
                    mediaFilename,
                    (bodies[0] || '').substring(0, 500),
                    impressions.lower_bound || '',
                    impressions.upper_bound || '',
                    spend.lower_bound || '',
                    spend.upper_bound || '',
                    ad.currency || '',
                    ad.ad_creation_time || '',
                    ad.ad_delivery_start_time || '',
                    ad.ad_delivery_stop_time || '',
                    platforms.join('; '),
                    ad.ad_snapshot_url || ''
                ];

                rowData.forEach(cell => {
                    const type = typeof cell === 'number' ? 'Number' : 'String';
                    xml += `        <Cell><Data ss:Type="${type}">${escapeXML(String(cell))}</Data></Cell>\n`;
                });
                xml += '      </Row>\n';
            });

            xml += '    </Table>\n';
            xml += '  </Worksheet>\n';
            xml += '</Workbook>';

            downloadFile(xml, `${pagePrefix}_export_${Date.now()}.xls`, 'application/vnd.ms-excel');
            showAlert('‚úÖ Excel —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω', 'success');
        }

        function escapeXML(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        // –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        function downloadCSV() {
            downloadFullCSV();
        }

        function downloadFile(content, filename, type) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + content], { type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function showAlert(message, type) {
            const alertsDiv = document.getElementById('alerts');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message.replace(/\n/g, '<br>');
            alertsDiv.appendChild(alertDiv);

            if (type !== 'error') {
                setTimeout(() => alertDiv.remove(), 5000);
            }
        }

        function clearAlerts() {
            document.getElementById('alerts').innerHTML = '';
        }

        function showLoading(show, text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
            document.getElementById('loading').classList.toggle('active', show);
            document.getElementById('loadingText').textContent = text;
            document.getElementById('fetchBtn').disabled = show;
        }

        function clearForm() {
            document.getElementById('accessToken').value = '';
            document.getElementById('pageId').value = '';
            document.getElementById('searchTerms').value = '';
            document.querySelectorAll('#countrySelect input').forEach(cb => {
                cb.checked = cb.value === 'US';
            });
            document.getElementById('adType').value = 'ALL';
            document.getElementById('adStatus').value = '';
            document.getElementById('limit').value = '100';
            document.getElementById('mediaType').value = '';
            document.getElementById('publisherPlatform').value = '';
            document.getElementById('resultsSection').classList.remove('active');
            allAds = [];
            clearAlerts();
            setSearchMode('page');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
            
            if (tab === 'request') {
                updateRequestDisplay();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            setSearchMode('page');
        });
    </script>
</body>
</html>
